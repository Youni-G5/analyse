<div class="sig-password-countdown" data-section-id="{{ section.id }}">
  
  <div class="background-media">
    {% case section.settings.background_type %}
      {% when 'image' %}
        {% if section.settings.background_image != blank %}
          {{ section.settings.background_image | image_url: width: 3000 | image_tag: class: 'background-media__image', loading: 'lazy', sizes: '100vw' }}
        {% endif %}
      {% when 'video' %}
        {% if section.settings.background_video != blank %}
          {{ section.settings.background_video | video_tag: class: 'background-media__video', autoplay: true, loop: true, muted: true, playsinline: true }}
        {% endif %}
    {% endcase %}
    <div class="background-overlay"></div>
  </div>

  <div class="wrapper">
    <header class="header">
      {% if section.settings.logo %}
        {{ section.settings.logo | image_url: width: section.settings.logo_width | image_tag: class: 'logo', alt: section.settings.logo.alt | default: 'Logo' }}
      {% else %}
        <p class="shop-name">{{ shop.name }}</p>
      {% endif %}
    </header>

    <main class="main">
      <h1 class="heading">{{ section.settings.heading | escape }}</h1>
      <p class="subheading">{{ section.settings.subheading | escape }}</p>

      {% if section.settings.show_countdown %}
        <div class="timer" id="Countdown-{{ section.id }}" data-countdown-date="{{ section.settings.countdown_date }}">
          <div class="timer-part"><span class="timer-number" data-days>00</span><span class="timer-label">{{ section.settings.text_days | escape }}</span></div>
          <div class="timer-part"><span class="timer-number" data-hours>00</span><span class="timer-label">{{ section.settings.text_hours | escape }}</span></div>
          <div class="timer-part"><span class="timer-number" data-minutes>00</span><span class="timer-label">{{ section.settings.text_minutes | escape }}</span></div>
          <div class="timer-part"><span class="timer-number" data-seconds>00</span><span class="timer-label">{{ section.settings.text_seconds | escape }}</span></div>
        </div>
      {% endif %}

      <div class="newsletter-wrapper" id="NewsletterWrapper-{{ section.id }}">
        {% form 'customer', class: 'newsletter-form' %}
          <input type="hidden" name="contact[tags]" value="prospect,password_page">
          <div class="form-group">
            <input type="email" name="contact[email]" id="PasswordEmail-{{ section.id }}" class="input" placeholder="{{ section.settings.email_placeholder | escape }}" required aria-label="{{ section.settings.email_placeholder | escape }}" autocomplete="email">
            <button type="submit" name="commit" class="button button--primary"><span>{{ section.settings.button_label | escape }}</span></button>
          </div>
        {% endform %}
      </div>
      <div class="newsletter-success" id="NewsletterSuccess-{{ section.id }}" style="display: none;">
        <p>{{ section.settings.success_message | escape }}</p>
      </div>

      {% if section.settings.show_social_links %}
        <div class="social-links">
          {%- if settings.social_facebook_link != blank -%}<a href="{{ settings.social_facebook_link }}" target="_blank" rel="noopener" aria-label="Facebook">{% render 'icon-facebook' %}</a>{%- endif -%}
          {%- if settings.social_instagram_link != blank -%}<a href="{{ settings.social_instagram_link }}" target="_blank" rel="noopener" aria-label="Instagram">{% render 'icon-instagram' %}</a>{%- endif -%}
          {%- if settings.social_x_link != blank -%}<a href="{{ settings.social_x_link }}" target="_blank" rel="noopener" aria-label="X">{% render 'icon-x' %}</a>{%- endif -%}
          {%- if settings.social_tiktok_link != blank -%}<a href="{{ settings.social_tiktok_link }}" target="_blank" rel="noopener" aria-label="TikTok">{% render 'icon-tiktok' %}</a>{%- endif -%}
          {%- if settings.social_pinterest_link != blank -%}<a href="{{ settings.social_pinterest_link }}" target="_blank" rel="noopener" aria-label="Pinterest">{% render 'icon-pinterest' %}</a>{%- endif -%}
        </div>
      {% endif %}
    </main>

    <footer class="footer">
      <a href="#LoginModal-{{ section.id }}" class="login-link" data-open-modal>Accès administrateur</a>
    </footer>
  </div>

  <div id="LoginModal-{{ section.id }}" class="login-modal" aria-hidden="true">
    <div class="modal-overlay" data-close-modal></div>
    <div class="modal-content">
      <button class="modal-close" data-close-modal aria-label="Fermer">&times;</button>
      <h3 class="modal-heading">Entrer avec un mot de passe</h3>
      <p class="modal-subheading">Cette boutique est protégée par un mot de passe.</p>
      {% form 'storefront_password', class: 'login-form' %}
        <div class="form-group">
          <input type="password" name="password" id="Password" class="input" placeholder="Mot de passe" autocomplete="current-password">
          <button type="submit" name="commit" class="button button--primary"><span>Entrer</span></button>
        </div>
        {% if form.errors %}<p class="error-message">{{ form.errors.messages['form'] }}</p>{% endif %}
      {% endform %}
    </div>
  </div>
</div>

<style>
  :root { --sig-modal-transition-speed: 0.4s; }
  .sig-password-countdown { position: relative; display: flex; align-items: center; justify-content: center; min-height: 100vh; background-color: {% if section.settings.background_type == 'color' %}{{ section.settings.color_bg }}{% else %}#000000{% endif %}; color: {{ section.settings.color_text }}; padding: 40px 20px; font-family: 'Helvetica Neue', sans-serif; overflow: hidden; }
  .sig-password-countdown .background-media { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
  .sig-password-countdown .background-media__image, .sig-password-countdown .background-media__video { width: 100%; height: 100%; object-fit: cover; }
  .sig-password-countdown .background-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000000; opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }}; z-index: 2; }
  .sig-password-countdown .wrapper { position: relative; z-index: 3; max-width: 640px; width: 100%; text-align: center; }
  .sig-password-countdown .header { margin-bottom: 60px; display: flex; justify-content: center; }
  .sig-password-countdown .logo { max-width: {{ section.settings.logo_width }}px; height: auto; }
  .sig-password-countdown .shop-name { font-size: 1rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; }
  .sig-password-countdown .main { padding-bottom: 40px; }
  .sig-password-countdown .heading { font-family: "Times New Roman", serif; font-size: 4.5rem; font-weight: 400; line-height: 1.1; margin: 0 0 20px; }
  .sig-password-countdown .subheading { font-size: 1.1rem; line-height: 1.6; max-width: 450px; margin: 0 auto 50px; opacity: 0.8; }
  .sig-password-countdown .timer { display: flex; justify-content: center; gap: 40px; margin-bottom: 50px; }
  .sig-password-countdown .timer-part { display: flex; flex-direction: column; }
  .sig-password-countdown .timer-number { font-size: 4rem; font-weight: 400; line-height: 1; }
  .sig-password-countdown .timer-label { font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 10px; opacity: 0.6; }
  .sig-password-countdown .form-group { display: flex; max-width: 450px; margin: 0 auto; border: 1px solid {{ section.settings.color_text | color_modify: 'alpha', 0.3 }}; border-radius: 6px; overflow: hidden; }
  .sig-password-countdown .input { flex-grow: 1; border: none; padding: 15px 20px; font-size: 1rem; background-color: transparent; color: {{ section.settings.color_text }}; -webkit-appearance: none; }
  .sig-password-countdown .input:focus { outline: none; }
  .sig-password-countdown .button { flex-shrink: 0; white-space: nowrap; border-radius: 0; border-top-right-radius: 5px; border-bottom-right-radius: 5px; padding: 15px 30px; background-color: {{ section.settings.color_text }}; color: {{ section.settings.color_bg }}; border: none; }
  .sig-password-countdown .button:hover { background-color: {{ section.settings.color_text | color_modify: 'alpha', 0.8 }}; color: {{ section.settings.color_bg }}; }
  .sig-password-countdown .footer { margin-top: 30px; }
  .sig-password-countdown .login-link { color: {{ section.settings.color_text }}; opacity: 0.6; text-decoration: none; font-size: 0.9rem; cursor: pointer; transition: opacity 0.2s ease; }
  .sig-password-countdown .login-link:hover { opacity: 1; }
  .sig-password-countdown .social-links { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 50px; }
  .sig-password-countdown .social-links a { color: {{ section.settings.color_text }}; opacity: 0.6; transition: opacity 0.2s ease; }
  .sig-password-countdown .social-links a:hover { opacity: 1; }
  .sig-password-countdown .social-links svg { width: 20px; height: 20px; fill: currentColor; }
  .sig-password-countdown .newsletter-success { padding: 15px 20px; font-size: 1rem; }
  .sig-password-countdown .login-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 100; display: flex; align-items: center; justify-content: center; visibility: hidden; opacity: 0; transition: visibility 0s var(--sig-modal-transition-speed), opacity var(--sig-modal-transition-speed) ease; }
  .sig-password-countdown .login-modal[aria-hidden="false"] { visibility: visible; opacity: 1; transition-delay: 0s; }
  .sig-password-countdown .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: {{ section.settings.color_bg | color_modify: 'alpha', 0.8 }}; backdrop-filter: blur(10px); cursor: pointer; }
  .sig-password-countdown .modal-content { position: relative; width: 90%; max-width: 480px; text-align: center; transform: translateY(20px); opacity: 0; transition: transform var(--sig-modal-transition-speed) ease, opacity var(--sig-modal-transition-speed) ease; }
  .sig-password-countdown .login-modal[aria-hidden="false"] .modal-content { transform: translateY(0); opacity: 1; }
  .sig-password-countdown .modal-heading { font-family: "Times New Roman", serif; font-size: 2.5rem; font-weight: 400; margin: 0 0 10px; }
  .sig-password-countdown .modal-subheading { margin: 0 auto 30px; opacity: 0.8; }
  .sig-password-countdown .modal-close { position: absolute; top: -40px; right: 0; background: none; border: none; font-size: 2rem; line-height: 1; color: {{ section.settings.color_text }}; cursor: pointer; opacity: 0.6; transition: opacity 0.2s; }
  .sig-password-countdown .modal-close:hover { opacity: 1; }
  .sig-password-countdown .error-message { color: #d9534f; margin-top: 15px; }

  @media (max-width: 749px) {
    .sig-password-countdown .heading { font-size: 2.8rem; }
    .sig-password-countdown .subheading { font-size: 1rem; margin-bottom: 40px; }
    .sig-password-countdown .timer { gap: 20px; margin-bottom: 40px; }
    .sig-password-countdown .timer-number { font-size: 2.5rem; }
    .sig-password-countdown .timer-label { font-size: 0.65rem; }
    .sig-password-countdown .form-group { max-width: 100%; }
    .sig-password-countdown .social-links { margin-top: 40px; }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sectionId = '{{ section.id }}';
    const countdownContainer = document.getElementById(`Countdown-${sectionId}`);
    
    if (countdownContainer) {
      const targetDate = new Date(countdownContainer.dataset.countdownDate).getTime();
      const updateCountdown = () => {
        const now = new Date().getTime();
        const distance = targetDate - now;
        if (distance < 0) {
          clearInterval(interval);
          countdownContainer.style.display = 'none';
          return;
        }
        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        countdownContainer.querySelector('[data-days]').textContent = String(days).padStart(2, '0');
        countdownContainer.querySelector('[data-hours]').textContent = String(hours).padStart(2, '0');
        countdownContainer.querySelector('[data-minutes]').textContent = String(minutes).padStart(2, '0');
        countdownContainer.querySelector('[data-seconds]').textContent = String(seconds).padStart(2, '0');
      };
      const interval = setInterval(updateCountdown, 1000);
      updateCountdown();
    }

    const newsletterForm = document.querySelector(`#NewsletterWrapper-${sectionId} form`);
    if (newsletterForm) {
      newsletterForm.addEventListener('submit', function(e) {
        e.preventDefault();
        fetch(this.action, {
          method: 'POST',
          body: new FormData(this),
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        }).then(() => {
          document.getElementById(`NewsletterWrapper-${sectionId}`).style.display = 'none';
          document.getElementById(`NewsletterSuccess-${sectionId}`).style.display = 'block';
        }).catch(err => console.error(err));
      });
    }

    const modal = document.getElementById(`LoginModal-${sectionId}`);
    const openModalLinks = document.querySelectorAll(`[data-section-id="${sectionId}"] [data-open-modal]`);
    const closeModalElements = document.querySelectorAll(`[data-section-id="${sectionId}"] [data-close-modal]`);

    const openModal = (e) => {
      e.preventDefault();
      modal.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    };
    const closeModal = () => {
      modal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    };

    openModalLinks.forEach(link => link.addEventListener('click', openModal));
    closeModalElements.forEach(el => el.addEventListener('click', closeModal));
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') {
        closeModal();
      }
    });
  });
</script>

{% schema %}
{
  "name": "Password",
  "settings": [
    { "type": "header", "content": "Logo" },
    { "type": "image_picker", "id": "logo", "label": "Logo" },
    { "type": "range", "id": "logo_width", "min": 50, "max": 200, "step": 5, "unit": "px", "label": "Largeur du logo", "default": 100 },
    { "type": "header", "content": "Arrière-plan" },
    { "type": "select", "id": "background_type", "label": "Type d'arrière-plan", "options": [ { "value": "color", "label": "Couleur" }, { "value": "image", "label": "Image" }, { "value": "video", "label": "Vidéo" } ], "default": "color" },
    { "type": "image_picker", "id": "background_image", "label": "Image d'arrière-plan" },
    { "type": "video_url", "id": "background_video", "label": "URL de la vidéo d'arrière-plan", "accept": ["youtube", "vimeo"], "info": "Utilisez un lien YouTube ou Vimeo." },
    { "type": "range", "id": "overlay_opacity", "label": "Opacité de la superposition", "min": 0, "max": 100, "step": 5, "unit": "%", "default": 0 },
    { "type": "header", "content": "Contenu principal" },
    { "type": "text", "id": "heading", "label": "Titre principal", "default": "L'ouverture est proche." },
    { "type": "textarea", "id": "subheading", "label": "Sous-titre", "default": "Notre nouvelle collection arrive bientôt. Entrez votre email pour être le premier informé." },
    { "type": "header", "content": "Compte à rebours" },
    { "type": "checkbox", "id": "show_countdown", "label": "Afficher le compte à rebours", "default": true },
    { "type": "text", "id": "countdown_date", "label": "Date de fin (AAAA-MM-JJ HH:MM)", "info": "Exemple : 2025-12-31 23:59" },
    { "type": "text", "id": "text_days", "label": "Texte 'Jours'", "default": "Jours" },
    { "type": "text", "id": "text_hours", "label": "Texte 'Heures'", "default": "Heures" },
    { "type": "text", "id": "text_minutes", "label": "Texte 'Minutes'", "default": "Minutes" },
    { "type": "text", "id": "text_seconds", "label": "Texte 'Secondes'", "default": "Secondes" },
    { "type": "header", "content": "Formulaire d'inscription" },
    { "type": "text", "id": "email_placeholder", "label": "Texte du champ email", "default": "Soyez prévenu(e) par email" },
    { "type": "text", "id": "button_label", "label": "Texte du bouton", "default": "Notifier" },
    { "type": "text", "id": "success_message", "label": "Message de succès", "default": "Merci ! Nous vous tiendrons informé." },
    {
      "type": "header",
      "content": "Liens sociaux"
    },
    {
      "type": "checkbox",
      "id": "show_social_links",
      "label": "Afficher les liens vers les profils sociaux",
      "default": true
    },
    { "type": "header", "content": "Couleurs" },
    { "type": "color", "id": "color_bg", "label": "Couleur de fond (si type 'Couleur')", "default": "#FFFFFF" },
    { "type": "color", "id": "color_text", "label": "Couleur du texte", "default": "#000000" }
  ]
}
{% endschema %}

<style>
  .product-list-carousel-section {
    margin: 0;
    width: 100%;
    max-width: 100%;
    padding: 32px 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
    font-size: 11.5px;
    line-height: 16px;
    -webkit-font-smoothing: antialiased;
    background-color: {{ section.settings.background_color }};
  }

  .product-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    margin-bottom: 16px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .header-link {
    text-decoration: none;
    color: inherit;
    transition: opacity 0.2s ease;
  }

  .header-link:hover {
    opacity: 0.7;
  }

  .section-title {
    font-size: 22px;
    font-weight: 600;
    line-height: 28px;
    margin: 0;
    letter-spacing: -0.02em;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .product-count {
    font-size: 13px;
    font-weight: 500;
    text-decoration: none;
    opacity: 0.7;
    transition: opacity 0.2s ease;
  }

  .product-count:hover {
    opacity: 1;
  }

  .caret-container {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .caret-icon {
    transform: rotate(-90deg);
    transition: transform 0.25s ease-in-out;
  }

  .product-carousel-container {
    min-height: 465px;
    overflow-x: scroll;
    overflow-y: hidden;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding-left: 16px;
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }

  .product-carousel-container::-webkit-scrollbar {
    display: none;
  }

  .product-carousel-container.is-dragging {
    scroll-behavior: auto;
  }

  .product-table-wrapper {
    display: flex;
    gap: 16px;
    padding-right: 16px;
  }

  .product-table-inner {
    flex-shrink: 0;
  }

  .product-table {
    border-collapse: collapse;
    border-spacing: 0;
    background: transparent;
  }

  .product-row {
    display: table-row;
  }

  .product-row.is-dragging .product-link {
    pointer-events: none;
  }

  .product-cell {
    padding: 12px 0;
    vertical-align: middle;
    border-top: 1px solid;
    border-bottom: 1px solid;
    border-color: inherit;
  }

  .product-row {
    border-color: rgba(255, 255, 255, 0.1);
  }

  .product-row[data-border-color] .product-cell {
    border-color: inherit;
  }

  .image-cell {
    width: 100px;
    padding-right: 16px;
  }

  .product-link {
    display: block;
    width: 100px;
    height: 100px;
    background: #000000;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: cursor 0.2s ease;
    text-decoration: none;
  }

  .product-link.is-dragging {
    pointer-events: none;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    transition: opacity 0.2s ease;
    user-select: none;
    -webkit-user-select: none;
    -webkit-user-drag: none;
    pointer-events: none;
    -webkit-touch-callout: none;
    display: block;
  }

  .product-link:hover .product-image {
    opacity: 0.8;
  }

  .product-carousel-container.is-dragging .product-link:hover .product-image {
    opacity: 1;
  }

  .name-cell {
    min-width: 250px;
    max-width: 300px;
    padding-right: 24px;
    font-size: 13px;
    font-weight: 500;
    line-height: 18px;
    user-select: none;
    -webkit-user-select: none;
  }

  .year-cell {
    min-width: 60px;
    text-align: left;
    padding-right: 16px;
    font-size: 13px;
    font-weight: 400;
    user-select: none;
    -webkit-user-select: none;
  }

  /* Responsive */
  @media screen and (max-width: 768px) {
    .product-list-carousel-section {
      padding: 24px 0;
    }

    .section-title {
      font-size: 18px;
      line-height: 24px;
    }

    .product-count {
      font-size: 12px;
    }

    .image-cell {
      width: 80px;
      padding-right: 12px;
    }

    .product-link {
      width: 80px;
      height: 80px;
    }

    .name-cell {
      min-width: 200px;
      max-width: 250px;
      font-size: 12px;
      padding-right: 16px;
    }

    .year-cell {
      min-width: 50px;
      font-size: 12px;
    }

    .product-cell {
      padding: 10px 0;
    }
  }

  @media screen and (max-width: 480px) {
    .section-title {
      font-size: 16px;
      line-height: 22px;
    }

    .name-cell {
      min-width: 180px;
      max-width: 220px;
      font-size: 11px;
    }
  }
</style>

<div class="product-list-carousel-section" data-section-id="{{ section.id }}">
  <div class="product-list-header">
    {% if section.settings.collection != blank %}
      <a href="{{ section.settings.collection.url }}" class="header-link">
        <h2 class="section-title" style="color: {{ section.settings.text_color }};">{{ section.settings.title }}</h2>
      </a>
      <div class="header-right">
        <a href="{{ section.settings.collection.url }}" class="product-count" style="color: {{ section.settings.text_color }};">
          {{ section.settings.collection.all_products_count }} {{ section.settings.count_text }}
        </a>
        <div class="caret-container">
          <svg width="8" height="8" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg" class="caret-icon">
            <path d="M1 1L5 5L9 1" stroke-width="1" stroke="{{ section.settings.text_color }}"></path>
          </svg>
        </div>
      </div>
    {% else %}
      <h2 class="section-title" style="color: {{ section.settings.text_color }};">{{ section.settings.title }}</h2>
    {% endif %}
  </div>

  <div class="product-carousel-container">
    <div class="product-table-wrapper">
      {% assign products_per_table = 4 %}
      {% assign product_count = 0 %}
      
      {% if section.settings.collection != blank %}
        {% assign collection = section.settings.collection %}
        {% assign total_products = section.settings.products_limit %}
        
        {% for product in collection.products limit: total_products %}
          {% assign position_in_table = product_count | modulo: products_per_table %}
          
          {% if product_count == 0 or position_in_table == 0 %}
            {% if product_count > 0 %}
              </tbody></table></div><div class="product-table-inner">
              <table class="product-table"><tbody>
            {% else %}
              <div class="product-table-inner">
                <table class="product-table">
                  <tbody>
            {% endif %}
          {% endif %}

          <tr class="product-row" data-border-color="{{ section.settings.border_color }}">
            <td class="product-cell image-cell">
              <a href="{{ product.url }}" class="product-link" data-product-url="{{ product.url }}">
                {% if product.featured_image %}
                  <img 
                    src="{{ product.featured_image | image_url: width: 750 }}"
                    srcset="
                      {{ product.featured_image | image_url: width: 50 }} 50w,
                      {{ product.featured_image | image_url: width: 100 }} 100w,
                      {{ product.featured_image | image_url: width: 200 }} 200w,
                      {{ product.featured_image | image_url: width: 300 }} 300w,
                      {{ product.featured_image | image_url: width: 500 }} 500w,
                      {{ product.featured_image | image_url: width: 750 }} 750w,
                      {{ product.featured_image | image_url: width: 1000 }} 1000w
                    "
                    sizes="(max-width: 768px) 80px, 100px"
                    alt="{{ product.title | escape }}"
                    class="product-image"
                    loading="lazy"
                    width="750"
                    height="750"
                    draggable="false"
                  >
                {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'product-image placeholder' }}
                {% endif %}
              </a>
            </td>
            <td class="product-cell name-cell" style="color: {{ section.settings.text_color }};">
              {{ product.title }}
            </td>
            <td class="product-cell year-cell" style="color: {{ section.settings.secondary_text_color }};">
              {% if product.metafields.custom.year != blank %}
                {{ product.metafields.custom.year }}
              {% endif %}
            </td>
          </tr>

          {% assign product_count = product_count | plus: 1 %}
        {% endfor %}

        {% if product_count > 0 %}
          </tbody></table></div>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<script>
(function() {
  const section = document.querySelector('[data-section-id="{{ section.id }}"]');
  if (!section) return;

  const carousel = section.querySelector('.product-carousel-container');
  if (!carousel) return;

  // Apply border color to all product rows
  const borderColor = '{{ section.settings.border_color }}';
  const productRows = section.querySelectorAll('.product-row');
  productRows.forEach(row => {
    row.style.borderColor = borderColor;
  });

  // Smooth scroll with mouse drag
  let isDown = false;
  let startX;
  let scrollLeft;
  let didDrag = false;
  const dragThreshold = 5;

  const handleMouseDown = (e) => {
    isDown = true;
    didDrag = false;
    carousel.classList.add('is-dragging');
    carousel.style.cursor = 'grabbing';
    startX = e.pageX - carousel.offsetLeft;
    scrollLeft = carousel.scrollLeft;
  };

  const handleMouseLeave = () => {
    if (isDown) {
      isDown = false;
      carousel.classList.remove('is-dragging');
      carousel.style.cursor = 'grab';
      updateProductLinks();
    }
  };

  const handleMouseUp = (e) => {
    if (isDown) {
      isDown = false;
      carousel.classList.remove('is-dragging');
      carousel.style.cursor = 'grab';
      updateProductLinks();
    }
  };

  const handleMouseMove = (e) => {
    if (!isDown) return;

    e.preventDefault();
    const x = e.pageX - carousel.offsetLeft;
    const walk = (x - startX) * 1.5;

    // Déterminer si l'utilisateur a dragué
    if (Math.abs(walk) > dragThreshold) {
      didDrag = true;
      disableProductLinks();
    }

    carousel.scrollLeft = scrollLeft - walk;
  };

  const disableProductLinks = () => {
    const links = section.querySelectorAll('.product-link');
    links.forEach(link => {
      link.classList.add('is-dragging');
    });
  };

  const updateProductLinks = () => {
    const links = section.querySelectorAll('.product-link');
    links.forEach(link => {
      link.classList.remove('is-dragging');
    });
  };

  // Ajouter les event listeners
  carousel.addEventListener('mousedown', handleMouseDown);
  carousel.addEventListener('mouseleave', handleMouseLeave);
  carousel.addEventListener('mouseup', handleMouseUp);
  carousel.addEventListener('mousemove', handleMouseMove);

  // Initialiser le curseur
  carousel.style.cursor = 'grab';

  // Nettoyer les listeners si la section est retirée
  const observer = new MutationObserver(() => {
    if (!document.contains(carousel)) {
      carousel.removeEventListener('mousedown', handleMouseDown);
      carousel.removeEventListener('mouseleave', handleMouseLeave);
      carousel.removeEventListener('mouseup', handleMouseUp);
      carousel.removeEventListener('mousemove', handleMouseMove);
      observer.disconnect();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
})();
</script>

{% schema %}
{
  "name": "Product List Carousel",
  "tag": "section",
  "class": "section-product-list-carousel",
  "settings": [
    {
      "type": "header",
      "content": "Section Content"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Fall Staples: Apparel & Accessories"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_limit",
      "min": 4,
      "max": 50,
      "step": 1,
      "default": 20,
      "label": "Number of products to show"
    },
    {
      "type": "text",
      "id": "count_text",
      "label": "Count Text",
      "default": "articles",
      "info": "Text to display after product count (e.g., 'articles', 'items', 'produits')"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "secondary_text_color",
      "label": "Secondary Text Color",
      "default": "#999999"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "rgba(255, 255, 255, 0.1)"
    }
  ],
  "presets": [
    {
      "name": "Product List Carousel",
      "category": "Produit"
    }
  ]
}
{% endschema %}

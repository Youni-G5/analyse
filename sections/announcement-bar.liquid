{% schema %}
{
  "name": "Barre d'annonce",
  "settings": [
    { "type": "header", "content": "Contenu Principal" },
    { "type": "checkbox", "id": "show_announcement_bar", "label": "Afficher la barre", "default": true },
    { "type": "checkbox", "id": "enable_sticky", "label": "Fixer en haut (Sticky)", "default": false },
    { "type": "textarea", "id": "text", "label": "Texte de l'annonce", "default": "LIVRAISON OFFERTE DÈS 50€" },
    { "type": "url", "id": "link", "label": "Lien (optionnel)" },
    { "type": "text", "id": "link_text", "label": "Texte du lien", "default": "VOIR PLUS" },
    
    { "type": "header", "content": "Sélecteurs (Style Nike)" },
    { "type": "select", "id": "selector_position", "label": "Position des sélecteurs", "options": [
      { "value": "left", "label": "Gauche" },
      { "value": "right", "label": "Droite" }
    ], "default": "right" },
    { "type": "checkbox", "id": "show_market_selector", "label": "Afficher le Pays/Devise", "default": true },
    { "type": "checkbox", "id": "show_language_selector", "label": "Afficher la Langue", "default": true },
    { "type": "checkbox", "id": "hide_language_mobile", "label": "Masquer la langue sur mobile", "default": true, "info": "Gagne de la place sur petit écran" },

    { "type": "header", "content": "Design" },
    { "type": "font_picker", "id": "font_family", "label": "Police", "default": "assistant_n7" },
    { "type": "color", "id": "bg_color", "label": "Arrière-plan", "default": "#F5F5F5" },
    { "type": "color", "id": "text_color", "label": "Texte", "default": "#111111" },
    { "type": "color", "id": "selector_bg", "label": "Fond menu déroulant", "default": "#FFFFFF" },
    { "type": "color", "id": "selector_text", "label": "Texte menu déroulant", "default": "#111111" }
  ],
  "presets": [
    {
      "name": "Barre d'annonce"
    }
  ]
}
{% endschema %}

{%- if section.settings.show_announcement_bar -%}

{%- style -%}
  {{ section.settings.font_family | font_face: font_display: 'swap' }}

  #shopify-section-{{ section.id }} {
    --ab-bg: {{ section.settings.bg_color }};
    --ab-text: {{ section.settings.text_color }};
    --ab-font: {{ section.settings.font_family.family }}, {{ section.settings.font_family.fallback_families }};
    --ab-font-weight: {{ section.settings.font_family.weight }};
    
    position: relative;
    z-index: 1001; 
    line-height: 1.2;
    margin: 0; /* Sécurité anti-décalage */
  }

  .can-announcement-bar {
    box-sizing: border-box; /* CORRECTION MAJEURE : Empêche le débordement lié au padding */
    background-color: var(--ab-bg);
    color: var(--ab-text);
    font-family: var(--ab-font);
    font-weight: var(--ab-font-weight);
    font-size: 11px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    
    width: 100%;
    max-width: 100vw; /* Sécurité supplémentaire */
    height: 40px;
    padding: 0 24px;
    margin: 0;
    
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
  }

  /* Conteneur des sélecteurs */
  .can-ab-selectors-wrapper {
    display: flex;
    align-items: center;
    gap: 16px;
    height: 100%;
  }

  /* Ajout de min-width: 0 pour éviter le blowout des grids sur mobile */
  .can-ab-col-left { justify-self: start; display: flex; height: 100%; align-items: center; min-width: 0; }
  .can-ab-col-center { justify-self: center; text-align: center; font-weight: 700; min-width: 0; }
  .can-ab-col-right { justify-self: end; display: flex; height: 100%; align-items: center; min-width: 0; }

  .can-announcement-bar a {
    color: inherit;
    text-decoration: underline;
    text-underline-offset: 2px;
    margin-left: 6px;
    font-weight: 700;
  }
  .can-announcement-bar a:hover { opacity: 0.7; text-decoration: none; }

  /* --- BOUTONS SELECTEURS --- */
  .can-selector-form {
    height: 100%;
    display: flex;
    align-items: center;
  }

  .can-selector-btn {
    appearance: none;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    outline: none !important;
    padding: 0 !important;
    margin: 0 !important;
    
    color: inherit;
    font-family: var(--ab-font);
    font-weight: 700;
    font-size: 11px;
    text-transform: uppercase;
    cursor: pointer;
    
    display: flex;
    align-items: center;
    gap: 6px;
    height: 100%;
    opacity: 1;
  }
  .can-selector-btn:hover { opacity: 0.6; }
  .can-selector-btn svg { width: 12px; height: 12px; fill: currentColor; }
  
  .can-selector-separator {
    width: 1px;
    height: 12px;
    background: currentColor;
    opacity: 0.2;
    display: block;
  }

  /* --- MENUS DÉROULANTS (PORTAL) --- */
  .can-portal-dropdown {
    position: absolute;
    min-width: 150px;
    max-height: 350px;
    overflow-y: auto;
    background: {{ section.settings.selector_bg }};
    color: {{ section.settings.selector_text }};
    border: 1px solid rgba(0,0,0,0.1);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    display: none; 
    z-index: 2147483647 !important;
    border-radius: 4px;
  }

  .can-portal-dropdown.is-open { display: block; }

  .can-portal-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 1px solid rgba(0,0,0,0.05);
    text-align: left;
    cursor: pointer;
    font-family: {{ section.settings.font_family.family }}, sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: inherit;
    text-transform: capitalize;
  }
  .can-portal-item:hover { background: rgba(0,0,0,0.05); }
  .can-portal-item.is-active { background: rgba(0,0,0,0.05); cursor: default; opacity: 0.5; }

  /* --- STICKY --- */
  .can-announcement-bar.is-sticky {
    position: fixed; top: 0; left: 0; right: 0;
    width: 100%; /* Force la largeur écran en mode sticky */
    z-index: 1000; 
  }
  .can-announcement-spacer { display: none; height: 0; }

  @media (max-width: 768px) {
    .can-announcement-bar { padding: 0 12px; grid-template-columns: auto 1fr auto; gap: 8px; }
    .can-ab-col-center { font-size: 10px; }
    .can-selector-btn span { display: none; }
    .can-selector-btn::after { content: attr(data-label); display: block; }
    .can-ab-selectors-wrapper { gap: 10px; }
    
    /* --- OPTION MASQUER LANGUE MOBILE --- */
    {% if section.settings.hide_language_mobile %}
      #AnnounceLanguageForm { display: none !important; }
      .can-selector-separator { display: none !important; }
    {% endif %}
  }
{%- endstyle -%}

{%- capture combined_selectors -%}
<div class="can-ab-selectors-wrapper">
  
  {%- if section.settings.show_language_selector and localization.available_languages.size > 1 -%}
    {%- form 'localization', id: 'AnnounceLanguageForm', class: 'can-selector-form' -%}
      <button type="button" class="can-selector-btn js-selector-trigger" aria-expanded="false" data-portal-id="LangPortal-{{ section.id }}" data-label="{{ localization.language.iso_code | upcase }}">
        <span>{{ localization.language.name }}</span>
        <svg viewBox="0 0 10 6"><path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" fill="none"/></svg>
      </button>
      <input type="hidden" name="locale_code" value="{{ localization.language.iso_code }}">
    {%- endform -%}

    <div id="LangPortal-{{ section.id }}" class="can-portal-dropdown">
      {%- for language in localization.available_languages -%}
        <button type="button" class="can-portal-item js-selector-item {% if language.iso_code == localization.language.iso_code %}is-active{% endif %}" 
                data-value="{{ language.iso_code }}">
          {{ language.endonym_name | capitalize }}
        </button>
      {%- endfor -%}
    </div>
  {%- endif -%}

  {%- if section.settings.show_language_selector and section.settings.show_market_selector and localization.available_languages.size > 1 -%}
    <span class="can-selector-separator"></span>
  {%- endif -%}

  {%- if section.settings.show_market_selector and localization.available_countries.size > 1 -%}
    {%- form 'localization', id: 'AnnounceMarketForm', class: 'can-selector-form' -%}
      <button type="button" class="can-selector-btn js-selector-trigger" aria-expanded="false" data-portal-id="MarketPortal-{{ section.id }}" data-label="{{ localization.country.iso_code }}">
        <svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        <span>{{ localization.country.name }}</span>
      </button>
      <input type="hidden" name="country_code" value="{{ localization.country.iso_code }}">
    {%- endform -%}

    <div id="MarketPortal-{{ section.id }}" class="can-portal-dropdown">
      {%- for country in localization.available_countries -%}
        <button type="button" class="can-portal-item js-selector-item {% if country.iso_code == localization.country.iso_code %}is-active{% endif %}" 
                data-value="{{ country.iso_code }}">
          {{ country.name }} ({{ country.currency.iso_code }})
        </button>
      {%- endfor -%}
    </div>
  {%- endif -%}

</div>
{%- endcapture -%}

<div class="can-announcement-wrapper" data-section-id="{{ section.id }}" style="overflow-x: clip;">
  <div id="announcement-bar-{{ section.id }}" 
       class="can-announcement-bar" 
       data-sticky="{{ section.settings.enable_sticky }}">
    
    <div class="can-ab-col-left">
      {%- if section.settings.selector_position == 'left' -%}
        {{ combined_selectors }}
      {%- endif -%}
    </div>

    <div class="can-ab-col-center">
      <span>{{ section.settings.text }}</span>
      {%- if section.settings.link != blank -%}
        <a href="{{ section.settings.link }}">{{ section.settings.link_text }}</a>
      {%- endif -%}
    </div>

    <div class="can-ab-col-right">
      {%- if section.settings.selector_position == 'right' -%}
        {{ combined_selectors }}
      {%- endif -%}
    </div>
  </div>
  <div class="can-announcement-spacer" id="spacer-{{ section.id }}"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  const container = document.querySelector(`[data-section-id="${sectionId}"]`);
  
  if(!container) return;

  // --- STICKY ---
  const bar = document.getElementById(`announcement-bar-${sectionId}`);
  const spacer = document.getElementById(`spacer-${sectionId}`);
  if (bar && bar.dataset.sticky === 'true' && spacer) {
    const updateHeight = () => spacer.style.height = `${bar.offsetHeight}px`;
    bar.classList.add('is-sticky');
    spacer.style.display = 'block';
    window.addEventListener('resize', updateHeight);
    setTimeout(updateHeight, 50);
  }

  // --- SYSTEME DE PORTAL ---
  const triggers = container.querySelectorAll('.js-selector-trigger');

  triggers.forEach(btn => {
    const portalId = btn.dataset.portalId;
    const dropdown = document.getElementById(portalId);
    const form = btn.closest('form');
    const inputName = form.id.includes('Language') ? 'locale_code' : 'country_code';
    const input = form.querySelector(`input[name="${inputName}"]`);

    if (dropdown) {
      document.body.appendChild(dropdown);

      const positionDropdown = () => {
        const rect = btn.getBoundingClientRect();
        const scrollY = window.scrollY || window.pageYOffset;
        const isRight = '{{ section.settings.selector_position }}' === 'right';
        
        dropdown.style.top = `${rect.bottom + scrollY}px`;
        
        if (isRight) {
          dropdown.style.left = 'auto';
          dropdown.style.right = `${document.body.clientWidth - rect.right}px`;
        } else {
          dropdown.style.left = `${rect.left}px`;
          dropdown.style.right = 'auto';
        }
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const wasOpen = dropdown.classList.contains('is-open');
        document.querySelectorAll('.can-portal-dropdown.is-open').forEach(el => el.classList.remove('is-open'));
        if (!wasOpen) {
          positionDropdown();
          dropdown.classList.add('is-open');
          btn.setAttribute('aria-expanded', 'true');
        }
      });

      dropdown.querySelectorAll('.js-selector-item').forEach(item => {
        item.addEventListener('click', (e) => {
          if(input) {
            input.value = item.dataset.value;
            form.submit();
          }
        });
      });

      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
          dropdown.classList.remove('is-open');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
      
      window.addEventListener('resize', () => { 
        if(dropdown.classList.contains('is-open')) positionDropdown(); 
      });
    }
  });
});
</script>
{%- endif -%}

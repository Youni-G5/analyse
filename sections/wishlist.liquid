{% comment %}
  Wishlist Premium - Inspiré Nike/Adidas
  Architecture: Grid responsive, micro-animations, toast notifications
  Performance: Lazy loading, skeleton states, optimized renders
{% endcomment %}

<section class="wishlist-premium" data-section-id="{{ section.id }}">
  <div class="page-width">
    
    {%- comment -%} Header avec compteur {%- endcomment -%}
    <header class="wishlist-header">
      <div class="wishlist-header__main">
        <svg class="wishlist-header__icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <h1 class="wishlist-header__title">{{ section.settings.title }}</h1>
      </div>
      <div class="wishlist-header__meta">
        <span class="wishlist-count" data-count-display>0 articles</span>
        <button class="button-link" data-action="clear-all" style="display:none;">Tout supprimer</button>
      </div>
    </header>

    {%- comment -%} Actions bulk (visible si articles sélectionnés) {%- endcomment -%}
    <div class="wishlist-bulk-bar hidden" data-bulk-bar>
      <span data-selected-count>0 sélectionné(s)</span>
      <div class="wishlist-bulk-bar__actions">
        <button class="button button--secondary button--small" data-bulk-action="add">Ajouter au panier</button>
        <button class="button button--tertiary button--small" data-bulk-action="remove">Supprimer</button>
      </div>
    </div>

    {%- comment -%} Grid principale {%- endcomment -%}
    <div class="wishlist-grid" data-wishlist-container>
      {%- comment -%} Le JavaScript injectera les cartes ici {%- endcomment -%}
    </div>

    {%- comment -%} État vide {%- endcomment -%}
    <div class="wishlist-empty hidden" data-empty-state>
      <div class="wishlist-empty__content">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <h2>Votre liste d'envies est vide</h2>
        <p>Parcourez nos collections et ajoutez vos coups de cœur</p>
        <a href="{{ routes.all_products_collection_url }}" class="button button--primary">Découvrir les produits</a>
      </div>
    </div>

  </div>
</section>

{%- comment -%} Toast notification {%- endcomment -%}
<div class="wishlist-toast" data-toast>Action effectuée</div>

{% style %}
  /* === VARIABLES === */
  .wishlist-premium {
    --wl-spacing: {{ section.settings.spacing | default: 20 }}px;
    --wl-card-radius: {{ section.settings.card_radius | default: 8 }}px;
    --wl-shadow: 0 2px 8px rgba(0,0,0,0.08);
    --wl-shadow-hover: 0 4px 16px rgba(0,0,0,0.12);
    padding: calc(var(--wl-spacing) * 2) 0;
  }

  /* === HEADER === */
  .wishlist-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.08);
  }

  .wishlist-header__main {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .wishlist-header__icon {
    color: #111;
  }

  .wishlist-header__title {
    margin: 0;
    font-size: clamp(1.5rem, 4vw, 2rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    text-transform: uppercase;
  }

  .wishlist-header__meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .wishlist-count {
    color: #757575;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .button-link {
    background: none;
    border: none;
    color: #111;
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.9rem;
    padding: 0;
    transition: opacity 0.2s;
  }

  .button-link:hover {
    opacity: 0.7;
  }

  /* === BULK BAR === */
  .wishlist-bulk-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f7f7f7;
    padding: 1rem 1.5rem;
    border-radius: var(--wl-card-radius);
    margin-bottom: 1.5rem;
  }

  .wishlist-bulk-bar__actions {
    display: flex;
    gap: 0.75rem;
  }

  /* === GRID LAYOUT === */
  .wishlist-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  @media (min-width: 750px) {
    .wishlist-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
  }

  @media (min-width: 990px) {
    .wishlist-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
    }
  }

  /* === PRODUCT CARD === */
  .wishlist-card {
    position: relative;
    display: flex;
    flex-direction: column;
    background: #fff;
    border-radius: var(--wl-card-radius);
    overflow: hidden;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s;
  }

  .wishlist-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--wl-shadow-hover);
  }

  /* Checkbox sélection */
  .wishlist-card__checkbox {
    position: absolute;
    top: 12px;
    left: 12px;
    width: 20px;
    height: 20px;
    z-index: 3;
    cursor: pointer;
    accent-color: #111;
  }

  /* Image */
  .wishlist-card__image-wrap {
    position: relative;
    aspect-ratio: 1 / 1;
    background: #f5f5f5;
    overflow: hidden;
  }

  .wishlist-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  .wishlist-card:hover .wishlist-card__image {
    transform: scale(1.05);
  }

  /* Quick actions overlay */
  .wishlist-card__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 2;
  }

  .wishlist-card:hover .wishlist-card__overlay {
    opacity: 1;
  }

  .wishlist-card__quick-actions {
    display: flex;
    gap: 0.5rem;
  }

  .wishlist-card__icon-btn {
    background: rgba(255,255,255,0.95);
    border: none;
    border-radius: 50%;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s, transform 0.2s;
  }

  .wishlist-card__icon-btn:hover {
    background: #fff;
    transform: scale(1.1);
  }

  .wishlist-card__icon-btn svg {
    width: 20px;
    height: 20px;
    stroke: #111;
  }

  /* Info section */
  .wishlist-card__info {
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex-grow: 1;
  }

  .wishlist-card__title {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    line-height: 1.3;
    color: #111;
  }

  .wishlist-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .wishlist-card__title a:hover {
    text-decoration: underline;
  }

  .wishlist-card__meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
    color: #757575;
    margin-bottom: 0.5rem;
  }

  .wishlist-card__price {
    font-weight: 600;
    color: #111;
  }

  .wishlist-card__stock {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .wishlist-card__stock--in {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .wishlist-card__stock--out {
    background: #ffebee;
    color: #c62828;
  }

  /* Note personnelle */
  .wishlist-card__note {
    font-size: 0.8rem;
    color: #666;
    font-style: italic;
    line-height: 1.4;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #f0f0f0;
  }

  /* Quantité */
  .wishlist-card__qty {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: 0.5rem;
  }

  .wishlist-card__qty-label {
    font-size: 0.85rem;
    color: #757575;
  }

  .wishlist-card__qty-controls {
    display: flex;
    align-items: center;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
  }

  .wishlist-card__qty-btn {
    background: none;
    border: none;
    padding: 4px 12px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
  }

  .wishlist-card__qty-btn:hover {
    background: #f5f5f5;
  }

  .wishlist-card__qty-value {
    padding: 4px 12px;
    min-width: 40px;
    text-align: center;
    border-left: 1px solid #ddd;
    border-right: 1px solid #ddd;
    font-weight: 600;
  }

  /* Bouton ATC */
  .wishlist-card__atc {
    width: 100%;
    margin-top: 0.75rem;
  }

  /* === EMPTY STATE === */
  .wishlist-empty {
    text-align: center;
    padding: 4rem 1rem;
  }

  .wishlist-empty__content {
    max-width: 400px;
    margin: 0 auto;
  }

  .wishlist-empty svg {
    color: #ddd;
    margin-bottom: 1.5rem;
  }

  .wishlist-empty h2 {
    margin: 0 0 0.5rem;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .wishlist-empty p {
    color: #757575;
    margin-bottom: 2rem;
  }

  /* === SKELETON LOADING === */
  .wishlist-skeleton {
    animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .wishlist-skeleton__image {
    aspect-ratio: 1 / 1;
    background: #f0f0f0;
    border-radius: var(--wl-card-radius) var(--wl-card-radius) 0 0;
  }

  .wishlist-skeleton__info {
    padding: 1rem;
  }

  .wishlist-skeleton__line {
    height: 12px;
    background: #f0f0f0;
    border-radius: 4px;
    margin-bottom: 0.5rem;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* === TOAST NOTIFICATION === */
  .wishlist-toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #111;
    color: #fff;
    padding: 12px 24px;
    border-radius: 50px;
    font-size: 0.9rem;
    font-weight: 500;
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s;
    z-index: 9999;
    pointer-events: none;
  }

  .wishlist-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  /* === UTILITIES === */
  .hidden {
    display: none !important;
  }

  /* Mobile adjustments */
  @media (max-width: 749px) {
    .wishlist-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .wishlist-header__meta {
      width: 100%;
      justify-content: space-between;
    }

    .wishlist-bulk-bar {
      flex-direction: column;
      gap: 1rem;
    }

    .wishlist-bulk-bar__actions {
      width: 100%;
      flex-direction: column;
    }

    .wishlist-card__overlay {
      opacity: 1;
      background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 50%);
    }

    .wishlist-card__quick-actions {
      position: absolute;
      bottom: 12px;
      right: 12px;
    }
  }
{% endstyle %}

<script>
(function() {
  'use strict';

  class PremiumWishlist {
    constructor() {
      this.STORAGE_KEY = 'wishlist-premium-v2';
      this.container = document.querySelector('[data-wishlist-container]');
      this.emptyState = document.querySelector('[data-empty-state]');
      this.countDisplay = document.querySelector('[data-count-display]');
      this.clearBtn = document.querySelector('[data-action="clear-all"]');
      this.bulkBar = document.querySelector('[data-bulk-bar]');
      this.selectedCountEl = document.querySelector('[data-selected-count]');
      this.toast = document.querySelector('[data-toast]');
      
      this.productsCache = {};
      this.selectedItems = new Set();
      this.moneyFormat = {{ shop.money_format | json }};
      
      this.init();
    }

    init() {
      this.render();
      this.attachEvents();
      window.addEventListener('wishlist:updated', () => this.render());
    }

    getWishlist() {
      try {
        const items = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        return Array.isArray(items) ? items : [];
      } catch {
        return [];
      }
    }

    setWishlist(items) {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(items));
      window.dispatchEvent(new CustomEvent('wishlist:updated', { detail: { count: items.length } }));
    }

    async render() {
      const items = this.getWishlist();
      
      // Update count
      this.countDisplay.textContent = `${items.length} article${items.length !== 1 ? 's' : ''}`;
      
      // Handle empty state
      if (items.length === 0) {
        this.container.innerHTML = '';
        this.container.classList.add('hidden');
        this.emptyState.classList.remove('hidden');
        this.clearBtn.style.display = 'none';
        this.bulkBar.classList.add('hidden');
        return;
      }

      this.container.classList.remove('hidden');
      this.emptyState.classList.add('hidden');
      this.clearBtn.style.display = 'block';

      // Show skeletons
      this.renderSkeletons(items.length);

      // Fetch products
      const products = await Promise.all(
        items.map(item => this.fetchProduct(item.handle))
      );

      // Render cards
      this.container.innerHTML = products
        .filter(p => p)
        .map((product, idx) => this.buildCard(product, items[idx]))
        .join('');
    }

    async fetchProduct(handle) {
      if (this.productsCache[handle]) return this.productsCache[handle];

      try {
        const res = await fetch(`/products/${handle}.js`);
        if (!res.ok) throw new Error('Not found');
        const product = await res.json();
        this.productsCache[handle] = product;
        return product;
      } catch {
        return null;
      }
    }

    buildCard(product, itemData) {
      const variant = product.variants[0];
      const price = this.formatMoney(variant.price);
      const inStock = variant.available;
      const qty = itemData.quantity || 1;
      const note = itemData.note || '';

      return `
        <div class="wishlist-card" data-handle="${product.handle}">
          <input type="checkbox" class="wishlist-card__checkbox" data-select="${product.handle}" aria-label="Sélectionner ${product.title}">
          
          <div class="wishlist-card__image-wrap">
            <a href="${product.url}">
              <img class="wishlist-card__image" 
                   src="${this.resizeImage(product.featured_image, '600x')}" 
                   alt="${product.title}" 
                   loading="lazy"
                   width="600" height="600">
            </a>
            <div class="wishlist-card__overlay">
              <div class="wishlist-card__quick-actions">
                <button class="wishlist-card__icon-btn" data-action="remove" data-handle="${product.handle}" aria-label="Supprimer">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                  </svg>
                </button>
                <button class="wishlist-card__icon-btn" data-action="add-to-cart" data-variant="${variant.id}" ${!inStock ? 'disabled' : ''} aria-label="Ajouter au panier">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="wishlist-card__info">
            <h3 class="wishlist-card__title">
              <a href="${product.url}">${product.title}</a>
            </h3>
            
            <div class="wishlist-card__meta">
              <span class="wishlist-card__price">${price}</span>
              <span class="wishlist-card__stock wishlist-card__stock--${inStock ? 'in' : 'out'}">
                ${inStock ? 'En stock' : 'Épuisé'}
              </span>
            </div>

            ${note ? `<div class="wishlist-card__note">"${note}"</div>` : ''}

            <div class="wishlist-card__qty">
              <span class="wishlist-card__qty-label">Qté:</span>
              <div class="wishlist-card__qty-controls">
                <button class="wishlist-card__qty-btn" data-action="qty-decrease" data-handle="${product.handle}" aria-label="Diminuer">−</button>
                <span class="wishlist-card__qty-value">${qty}</span>
                <button class="wishlist-card__qty-btn" data-action="qty-increase" data-handle="${product.handle}" aria-label="Augmenter">+</button>
              </div>
            </div>

            <button class="button button--primary wishlist-card__atc" data-action="add-to-cart" data-variant="${variant.id}" ${!inStock ? 'disabled' : ''}>
              ${inStock ? 'Ajouter au panier' : 'Épuisé'}
            </button>
          </div>
        </div>
      `;
    }

    renderSkeletons(count) {
      const skeleton = `
        <div class="wishlist-skeleton">
          <div class="wishlist-skeleton__image"></div>
          <div class="wishlist-skeleton__info">
            <div class="wishlist-skeleton__line" style="width:80%"></div>
            <div class="wishlist-skeleton__line" style="width:40%"></div>
            <div class="wishlist-skeleton__line" style="width:60%"></div>
          </div>
        </div>
      `;
      this.container.innerHTML = skeleton.repeat(Math.min(count, 8));
    }

    attachEvents() {
      // Event delegation
      this.container.addEventListener('click', (e) => {
        const action = e.target.closest('[data-action]');
        if (!action) return;

        const handle = action.dataset.handle;
        const variantId = action.dataset.variant;

        switch(action.dataset.action) {
          case 'remove':
            this.removeItem(handle);
            break;
          case 'add-to-cart':
            this.addToCart(variantId, action);
            break;
          case 'qty-increase':
            this.updateQty(handle, 1);
            break;
          case 'qty-decrease':
            this.updateQty(handle, -1);
            break;
        }
      });

      // Selection checkboxes
      this.container.addEventListener('change', (e) => {
        if (e.target.matches('[data-select]')) {
          this.toggleSelection(e.target.dataset.select, e.target.checked);
        }
      });

      // Clear all
      this.clearBtn.addEventListener('click', () => {
        if (confirm('Vider votre liste d\'envies ?')) {
          this.setWishlist([]);
          this.showToast('Liste vidée');
        }
      });

      // Bulk actions
      document.querySelectorAll('[data-bulk-action]').forEach(btn => {
        btn.addEventListener('click', () => {
          if (btn.dataset.bulkAction === 'remove') this.bulkRemove();
          if (btn.dataset.bulkAction === 'add') this.bulkAddToCart();
        });
      });
    }

    removeItem(handle) {
      const items = this.getWishlist().filter(i => i.handle !== handle);
      this.setWishlist(items);
      this.showToast('Produit retiré');
    }

    updateQty(handle, delta) {
      const items = this.getWishlist();
      const item = items.find(i => i.handle === handle);
      if (item) {
        item.quantity = Math.max(1, (item.quantity || 1) + delta);
        this.setWishlist(items);
      }
    }

    async addToCart(variantId, btn) {
      const originalText = btn.textContent;
      btn.textContent = '...';
      btn.disabled = true;

      try {
        const res = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: [{ id: variantId, quantity: 1 }] })
        });

        if (res.ok) {
          this.showToast('Ajouté au panier !');
          document.querySelector('cart-drawer')?.open();
        }
      } catch (e) {
        console.error(e);
      } finally {
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    toggleSelection(handle, selected) {
      if (selected) this.selectedItems.add(handle);
      else this.selectedItems.delete(handle);

      this.updateBulkBar();
    }

    updateBulkBar() {
      const count = this.selectedItems.size;
      if (count > 0) {
        this.bulkBar.classList.remove('hidden');
        this.selectedCountEl.textContent = `${count} sélectionné${count > 1 ? 's' : ''}`;
      } else {
        this.bulkBar.classList.add('hidden');
      }
    }

    bulkRemove() {
      if (confirm(`Supprimer ${this.selectedItems.size} articles ?`)) {
        const items = this.getWishlist().filter(i => !this.selectedItems.has(i.handle));
        this.setWishlist(items);
        this.selectedItems.clear();
        this.showToast('Articles supprimés');
      }
    }

    async bulkAddToCart() {
      const items = this.getWishlist().filter(i => this.selectedItems.has(i.handle));
      const cartItems = [];

      for (const item of items) {
        const product = await this.fetchProduct(item.handle);
        if (product?.variants[0]?.available) {
          cartItems.push({ id: product.variants[0].id, quantity: item.quantity || 1 });
        }
      }

      if (cartItems.length > 0) {
        try {
          await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cartItems })
          });
          this.showToast(`${cartItems.length} articles ajoutés !`);
          document.querySelector('cart-drawer')?.open();
        } catch (e) {
          console.error(e);
        }
      }
    }

    resizeImage(url, size) {
      if (!url) return '';
      return url.replace(/\.(jpg|png|gif|jpeg|webp)/i, `_${size}.$1`);
    }

    formatMoney(cents) {
      const value = (cents / 100).toFixed(2);
      return this.moneyFormat.replace(/\{\{\s*amount\s*\}\}/, value);
    }

    showToast(message) {
      this.toast.textContent = message;
      this.toast.classList.add('show');
      setTimeout(() => this.toast.classList.remove('show'), 3000);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new PremiumWishlist());
  } else {
    new PremiumWishlist();
  }
})();
</script>

{% schema %}
{
  "name": "Wishlist Premium",
  "settings": [
    {
      "type": "header",
      "content": "Contenu"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Ma Liste d'Envies"
    },
    {
      "type": "header",
      "content": "Style"
    },
    {
      "type": "range",
      "id": "spacing",
      "min": 10,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Espacement",
      "default": 20
    },
    {
      "type": "range",
      "id": "card_radius",
      "min": 0,
      "max": 20,
      "step": 2,
      "unit": "px",
      "label": "Bordure arrondie cartes",
      "default": 8
    }
  ],
  "presets": [
    {
      "name": "Wishlist Premium"
    }
  ]
}
{% endschema %}

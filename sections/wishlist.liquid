{% comment %}
  Wishlist Premium Grid - Design Nike/Adidas
  Mobile-first responsive design
  Compatible: 100% avec système existant (wishlist-sig-items)
{% endcomment %}

<section class="wishlist-premium-grid" data-section-id="{{ section.id }}">
  <div class="page-width">

    {%- comment -%} Header moderne avec compteur {%- endcomment -%}
    <header class="wl-header">
      <div class="wl-header__main">
        <svg class="wl-header__icon" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <h1 class="wl-header__title">{{ section.settings.title }}</h1>
      </div>
      <div class="wl-header__actions">
        <span class="wl-count" data-count-display>0 articles</span>
        <button class="wl-btn-clear" data-clear-all style="display:none;">Tout supprimer</button>
      </div>
    </header>

    {%- comment -%} Grid principale (cartes produits) {%- endcomment -%}
    <div class="wl-grid" data-wishlist-container>
      {%- comment -%} JavaScript injecte les cartes ici {%- endcomment -%}
    </div>

    {%- comment -%} Empty state {%- endcomment -%}
    <div class="wl-empty hidden" data-empty-state>
      <div class="wl-empty__content">
        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
        <h2>Votre liste d'envies est vide</h2>
        <p>Découvrez nos collections et ajoutez vos coups de cœur</p>
        <a href="{{ routes.all_products_collection_url }}" class="wl-btn wl-btn--primary">Explorer les produits</a>
      </div>
    </div>

    {%- comment -%} Actions bulk (bottom sticky bar) {%- endcomment -%}
    <div class="wl-bulk-bar hidden" data-bulk-bar>
      <span class="wl-bulk-bar__count" data-selected-count>0 sélectionné(s)</span>
      <div class="wl-bulk-bar__actions">
        <button class="wl-btn wl-btn--secondary" data-bulk-add>Ajouter au panier</button>
        <button class="wl-btn wl-btn--ghost" data-bulk-remove>Supprimer</button>
      </div>
    </div>

  </div>
</section>

{%- comment -%} Toast notification {%- endcomment -%}
<div class="wl-toast" data-toast>
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <polyline points="20 6 9 17 4 12"></polyline>
  </svg>
  <span>Action effectuée</span>
</div>

{% style %}
  /* ========== MOBILE FIRST DESIGN SYSTEM ========== */
  .wishlist-premium-grid {
    --wl-primary: #111;
    --wl-text: #111;
    --wl-text-light: #757575;
    --wl-border: #e5e5e5;
    --wl-bg: #ffffff;
    --wl-bg-hover: #f5f5f5;
    --wl-radius: 8px;
    --wl-shadow: 0 2px 8px rgba(0,0,0,0.08);
    --wl-shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    --wl-transition: cubic-bezier(0.4, 0, 0.2, 1);
    padding: 1.5rem 0 5rem;
  }

  /* ========== HEADER (MOBILE FIRST) ========== */
  .wl-header {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--wl-border);
  }

  .wl-header__main {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .wl-header__icon {
    color: var(--wl-text);
    width: 32px;
    height: 32px;
  }

  .wl-header__title {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .wl-header__actions {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .wl-count {
    color: var(--wl-text-light);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .wl-btn-clear {
    background: none;
    border: none;
    color: var(--wl-text);
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.875rem;
    padding: 0;
    transition: opacity 0.2s;
  }

  .wl-btn-clear:hover {
    opacity: 0.6;
  }

  /* ========== GRID RESPONSIVE (MOBILE FIRST) ========== */
  .wl-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  /* ========== PRODUCT CARD (MOBILE FIRST) ========== */
  .wl-card {
    position: relative;
    display: flex;
    flex-direction: column;
    background: var(--wl-bg);
    border-radius: var(--wl-radius);
    overflow: hidden;
    transition: transform 0.3s var(--wl-transition), box-shadow 0.3s var(--wl-transition);
  }

  /* Checkbox sélection */
  .wl-card__checkbox {
    position: absolute;
    top: 8px;
    left: 8px;
    width: 20px;
    height: 20px;
    z-index: 4;
    cursor: pointer;
    accent-color: var(--wl-primary);
  }

  /* Image avec aspect ratio */
  .wl-card__media {
    position: relative;
    aspect-ratio: 1 / 1;
    background: #f7f7f7;
    overflow: hidden;
  }

  .wl-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  /* Quick actions overlay (TOUJOURS visible sur mobile) */
  .wl-card__overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 100%);
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 0.75rem;
    z-index: 3;
  }

  .wl-card__quick-actions {
    display: flex;
    gap: 0.5rem;
  }

  .wl-card__icon-btn {
    background: rgba(255,255,255,0.95);
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: transform 0.2s, background 0.2s;
  }

  .wl-card__icon-btn:active {
    transform: scale(0.95);
  }

  .wl-card__icon-btn svg {
    width: 18px;
    height: 18px;
    stroke: var(--wl-text);
    stroke-width: 2;
  }

  /* Infos produit (MOBILE) */
  .wl-card__info {
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .wl-card__title {
    margin: 0;
    font-size: 0.875rem;
    font-weight: 600;
    line-height: 1.3;
    color: var(--wl-text);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .wl-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .wl-card__meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
  }

  .wl-card__price {
    font-weight: 600;
    color: var(--wl-text);
  }

  .wl-card__stock {
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 500;
  }

  .wl-card__stock--in {
    background: #e8f5e9;
    color: #2e7d32;
  }

  .wl-card__stock--out {
    background: #ffebee;
    color: #c62828;
  }

  /* Footer card (quantité) */
  .wl-card__footer {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--wl-border);
    margin-top: auto;
  }

  .wl-card__qty {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.8rem;
  }

  .wl-card__qty-label {
    color: var(--wl-text-light);
  }

  .wl-card__qty-controls {
    display: flex;
    align-items: center;
    border: 1px solid var(--wl-border);
    border-radius: 20px;
    overflow: hidden;
  }

  .wl-card__qty-btn {
    background: none;
    border: none;
    padding: 4px 10px;
    cursor: pointer;
    font-size: 0.875rem;
    color: var(--wl-text-light);
    transition: background 0.2s;
  }

  .wl-card__qty-btn:active {
    background: var(--wl-bg-hover);
  }

  .wl-card__qty-value {
    padding: 0 10px;
    font-weight: 600;
    min-width: 28px;
    text-align: center;
    font-size: 0.875rem;
  }

  .wl-card__note {
    font-size: 0.75rem;
    color: var(--wl-text-light);
    font-style: italic;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* Bouton ATC */
  .wl-card__atc {
    width: 100%;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    padding: 0.625rem 1rem;
  }

  /* ========== BULK BAR (MOBILE FIRST) ========== */
  .wl-bulk-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--wl-primary);
    color: white;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    transform: translateY(100%);
    transition: transform 0.3s var(--wl-transition);
  }

  .wl-bulk-bar:not(.hidden) {
    transform: translateY(0);
  }

  .wl-bulk-bar__count {
    font-weight: 600;
    font-size: 0.875rem;
    text-align: center;
  }

  .wl-bulk-bar__actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .wl-bulk-bar__actions .wl-btn {
    width: 100%;
  }

  /* ========== EMPTY STATE ========== */
  .wl-empty {
    text-align: center;
    padding: 3rem 1rem;
  }

  .wl-empty__content {
    max-width: 400px;
    margin: 0 auto;
  }

  .wl-empty svg {
    color: #ddd;
    margin-bottom: 1.5rem;
  }

  .wl-empty h2 {
    margin: 0 0 0.75rem;
    font-size: 1.25rem;
    font-weight: 700;
  }

  .wl-empty p {
    color: var(--wl-text-light);
    margin-bottom: 1.5rem;
    line-height: 1.5;
    font-size: 0.9rem;
  }

  /* ========== SKELETON LOADING ========== */
  .wl-skeleton {
    animation: wl-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .wl-skeleton__media {
    aspect-ratio: 1 / 1;
    background: #f0f0f0;
    border-radius: var(--wl-radius) var(--wl-radius) 0 0;
  }

  .wl-skeleton__info {
    padding: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .wl-skeleton__line {
    height: 10px;
    background: #f0f0f0;
    border-radius: 4px;
  }

  @keyframes wl-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ========== TOAST NOTIFICATION ========== */
  .wl-toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--wl-primary);
    color: white;
    padding: 10px 20px;
    border-radius: 50px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 500;
    opacity: 0;
    transition: transform 0.4s var(--wl-transition), opacity 0.4s;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .wl-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  /* ========== BUTTONS ========== */
  .wl-btn {
    padding: 0.75rem 1.5rem;
    border-radius: var(--wl-radius);
    border: none;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
  }

  .wl-btn--primary {
    background: var(--wl-primary);
    color: white;
  }

  .wl-btn--primary:active {
    background: #000;
  }

  .wl-btn--secondary {
    background: white;
    color: var(--wl-primary);
    border: 1px solid var(--wl-border);
  }

  .wl-btn--secondary:active {
    background: var(--wl-bg-hover);
  }

  .wl-btn--ghost {
    background: transparent;
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .wl-btn--ghost:active {
    background: rgba(255,255,255,0.1);
  }

  .wl-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ========== UTILITIES ========== */
  .hidden {
    display: none !important;
  }

  /* ========== TABLET (min-width: 750px) ========== */
  @media (min-width: 750px) {
    .wishlist-premium-grid {
      padding: 2rem 0 6rem;
    }

    .wl-header {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1.25rem;
    }

    .wl-header__icon {
      width: 36px;
      height: 36px;
    }

    .wl-header__title {
      font-size: 2rem;
    }

    .wl-header__actions {
      width: auto;
      gap: 1.5rem;
    }

    .wl-count {
      font-size: 0.9rem;
    }

    .wl-btn-clear {
      font-size: 0.9rem;
    }

    /* Grid 3 colonnes */
    .wl-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }

    /* Cards plus grandes */
    .wl-card__checkbox {
      top: 10px;
      left: 10px;
      width: 22px;
      height: 22px;
    }

    .wl-card__info {
      padding: 1rem;
    }

    .wl-card__title {
      font-size: 0.95rem;
    }

    .wl-card__meta {
      font-size: 0.9rem;
    }

    .wl-card__icon-btn {
      width: 44px;
      height: 44px;
    }

    .wl-card__icon-btn svg {
      width: 20px;
      height: 20px;
    }

    .wl-card__qty {
      font-size: 0.85rem;
    }

    .wl-card__note {
      font-size: 0.8rem;
    }

    .wl-card__atc {
      font-size: 0.9rem;
      padding: 0.75rem 1.25rem;
    }

    /* Overlay au hover uniquement */
    .wl-card__overlay {
      background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 60%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .wl-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--wl-shadow-lg);
    }

    .wl-card:hover .wl-card__image {
      transform: scale(1.05);
    }

    .wl-card:hover .wl-card__overlay {
      opacity: 1;
    }

    .wl-card__icon-btn:hover {
      background: #fff;
      transform: scale(1.1);
    }

    /* Bulk bar horizontal */
    .wl-bulk-bar {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }

    .wl-bulk-bar__count {
      text-align: left;
      font-size: 0.95rem;
    }

    .wl-bulk-bar__actions {
      flex-direction: row;
      gap: 0.75rem;
    }

    .wl-bulk-bar__actions .wl-btn {
      width: auto;
    }

    /* Toast */
    .wl-toast {
      padding: 12px 24px;
      font-size: 0.9rem;
      bottom: 24px;
    }

    /* Empty state */
    .wl-empty {
      padding: 4rem 1rem;
    }

    .wl-empty h2 {
      font-size: 1.5rem;
    }

    .wl-empty p {
      font-size: 1rem;
    }
  }

  /* ========== DESKTOP (min-width: 990px) ========== */
  @media (min-width: 990px) {
    .wishlist-premium-grid {
      padding: 2.5rem 0 6rem;
    }

    .wl-header {
      margin-bottom: 2.5rem;
      padding-bottom: 1.5rem;
    }

    .wl-header__icon {
      width: 40px;
      height: 40px;
    }

    .wl-header__title {
      font-size: 2.5rem;
    }

    .wl-count {
      font-size: 0.95rem;
    }

    /* Grid 4 colonnes */
    .wl-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 2rem;
    }

    .wl-card__checkbox {
      top: 12px;
      left: 12px;
    }

    .wl-card__atc {
      margin-top: 0.75rem;
    }
  }

  /* ========== LARGE DESKTOP (min-width: 1400px) ========== */
  @media (min-width: 1400px) {
    .wl-grid {
      gap: 2.5rem;
    }
  }
{% endstyle %}

<script>
(function() {
  'use strict';

  class WishlistPremium {
    constructor() {
      this.NAMESPACE = 'wishlist-sig-';
      this.STORAGE_KEY = this.NAMESPACE + 'items';
      this.container = document.querySelector('[data-wishlist-container]');
      this.emptyState = document.querySelector('[data-empty-state]');
      this.countDisplay = document.querySelector('[data-count-display]');
      this.clearBtn = document.querySelector('[data-clear-all]');
      this.bulkBar = document.querySelector('[data-bulk-bar]');
      this.selectedCountEl = document.querySelector('[data-selected-count]');
      this.toast = document.querySelector('[data-toast]');
      
      this.productsCache = {};
      this.selectedItems = new Set();
      this.moneyFormat = {{ shop.money_format | json }};
      
      if (!this.container) return;
      this.init();
    }

    init() {
      this.render();
      this.attachEvents();
      window.addEventListener(this.NAMESPACE + 'updated', () => this.render());
    }

    getWishlist() {
      try {
        const items = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        return Array.isArray(items) ? items : [];
      } catch {
        return [];
      }
    }

    setWishlist(items) {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(items));
      window.dispatchEvent(new CustomEvent(this.NAMESPACE + 'updated'));
    }

    async render() {
      const items = this.getWishlist();
      
      this.countDisplay.textContent = `${items.length} article${items.length !== 1 ? 's' : ''}`;
      
      if (items.length === 0) {
        this.container.innerHTML = '';
        this.container.classList.add('hidden');
        this.emptyState.classList.remove('hidden');
        this.clearBtn.style.display = 'none';
        return;
      }

      this.container.classList.remove('hidden');
      this.emptyState.classList.add('hidden');
      this.clearBtn.style.display = 'block';

      this.renderSkeletons(items.length);

      const products = await Promise.all(
        items.map(item => this.fetchProduct(item.handle))
      );

      this.container.innerHTML = products
        .filter(p => p)
        .map((product, idx) => this.buildCard(product, items[idx]))
        .join('');
    }

    async fetchProduct(handle) {
      if (this.productsCache[handle]) return this.productsCache[handle];

      try {
        const res = await fetch(`/products/${handle}.js`);
        if (!res.ok) throw new Error('Not found');
        const product = await res.json();
        this.productsCache[handle] = product;
        return product;
      } catch {
        return null;
      }
    }

    buildCard(product, itemData) {
      const variant = product.variants[0];
      const price = this.formatMoney(variant.price);
      const inStock = variant.available;
      const qty = itemData.quantity || 1;
      const note = itemData.note || '';
      const imageUrl = this.resizeImage(product.featured_image, '600x');

      return `
        <div class="wl-card" data-handle="${product.handle}">
          <input type="checkbox" class="wl-card__checkbox" data-select="${product.handle}" aria-label="Sélectionner ${product.title}">
          
          <div class="wl-card__media">
            <a href="${product.url}">
              <img class="wl-card__image" src="${imageUrl}" alt="${product.title}" loading="lazy" width="600" height="600">
            </a>
            <div class="wl-card__overlay">
              <div class="wl-card__quick-actions">
                <button class="wl-card__icon-btn" data-action="remove" data-handle="${product.handle}" title="Supprimer">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
                <button class="wl-card__icon-btn" data-action="quick-add" data-handle="${product.handle}" ${!inStock ? 'disabled' : ''} title="Ajouter au panier">
                  <svg viewBox="0 0 24 24" fill="none"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" stroke="currentColor" stroke-width="2"/></svg>
                </button>
              </div>
            </div>
          </div>

          <div class="wl-card__info">
            <h3 class="wl-card__title"><a href="${product.url}">${product.title}</a></h3>
            
            <div class="wl-card__meta">
              <span class="wl-card__price">${price}</span>
              <span class="wl-card__stock wl-card__stock--${inStock ? 'in' : 'out'}">${inStock ? 'En stock' : 'Épuisé'}</span>
            </div>

            <div class="wl-card__footer">
              <div class="wl-card__qty">
                <span class="wl-card__qty-label">Quantité</span>
                <div class="wl-card__qty-controls">
                  <button class="wl-card__qty-btn" data-action="qty-dec" data-handle="${product.handle}">−</button>
                  <span class="wl-card__qty-value">${qty}</span>
                  <button class="wl-card__qty-btn" data-action="qty-inc" data-handle="${product.handle}">+</button>
                </div>
              </div>
              ${note ? `<div class="wl-card__note" title="${note}">${note}</div>` : ''}
            </div>

            <button class="wl-btn wl-btn--primary wl-card__atc" data-action="add-cart" data-handle="${product.handle}" ${!inStock ? 'disabled' : ''}>
              ${inStock ? 'Ajouter au panier' : 'Épuisé'}
            </button>
          </div>
        </div>
      `;
    }

    renderSkeletons(count) {
      const skeleton = `
        <div class="wl-card wl-skeleton">
          <div class="wl-skeleton__media"></div>
          <div class="wl-skeleton__info">
            <div class="wl-skeleton__line" style="width:80%"></div>
            <div class="wl-skeleton__line" style="width:40%"></div>
            <div class="wl-skeleton__line" style="width:60%"></div>
          </div>
        </div>
      `;
      this.container.innerHTML = skeleton.repeat(Math.min(count, 8));
    }

    attachEvents() {
      this.container.addEventListener('click', (e) => {
        const action = e.target.closest('[data-action]');
        if (!action) return;

        const handle = action.dataset.handle;

        switch(action.dataset.action) {
          case 'remove': this.removeItem(handle); break;
          case 'quick-add':
          case 'add-cart': this.addToCart(handle, action); break;
          case 'qty-inc': this.updateQty(handle, 1); break;
          case 'qty-dec': this.updateQty(handle, -1); break;
        }
      });

      this.container.addEventListener('change', (e) => {
        if (e.target.matches('[data-select]')) {
          this.toggleSelection(e.target.dataset.select, e.target.checked);
        }
      });

      this.clearBtn?.addEventListener('click', () => {
        if (confirm('Vider votre liste d\'envies ?')) {
          this.setWishlist([]);
          this.showToast('Liste vidée');
        }
      });

      document.querySelector('[data-bulk-add]')?.addEventListener('click', () => this.bulkAddToCart());
      document.querySelector('[data-bulk-remove]')?.addEventListener('click', () => this.bulkRemove());
    }

    removeItem(handle) {
      const items = this.getWishlist().filter(i => i.handle !== handle);
      this.setWishlist(items);
      this.showToast('Produit retiré');
    }

    updateQty(handle, delta) {
      const items = this.getWishlist();
      const item = items.find(i => i.handle === handle);
      if (item) {
        item.quantity = Math.max(1, (item.quantity || 1) + delta);
        this.setWishlist(items);
      }
    }

    async addToCart(handle, btn) {
      const item = this.getWishlist().find(i => i.handle === handle);
      const product = this.productsCache[handle];
      if (!item || !product) return;

      const originalText = btn.textContent;
      btn.textContent = '...';
      btn.disabled = true;

      try {
        await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: [{ id: product.variants[0].id, quantity: item.quantity || 1 }] })
        });
        this.showToast('Ajouté au panier !');
        document.querySelector('cart-drawer')?.open();
      } catch (e) {
        console.error(e);
      } finally {
        btn.textContent = originalText;
        btn.disabled = !product.variants[0].available;
      }
    }

    toggleSelection(handle, selected) {
      if (selected) this.selectedItems.add(handle);
      else this.selectedItems.delete(handle);
      this.updateBulkBar();
    }

    updateBulkBar() {
      const count = this.selectedItems.size;
      if (count > 0) {
        this.bulkBar.classList.remove('hidden');
        this.selectedCountEl.textContent = `${count} sélectionné${count > 1 ? 's' : ''}`;
      } else {
        this.bulkBar.classList.add('hidden');
      }
    }

    bulkRemove() {
      if (confirm(`Supprimer ${this.selectedItems.size} articles ?`)) {
        const items = this.getWishlist().filter(i => !this.selectedItems.has(i.handle));
        this.setWishlist(items);
        this.selectedItems.clear();
        this.showToast('Articles supprimés');
      }
    }

    async bulkAddToCart() {
      const items = this.getWishlist().filter(i => this.selectedItems.has(i.handle));
      const cartItems = [];

      for (const item of items) {
        const product = await this.fetchProduct(item.handle);
        if (product?.variants[0]?.available) {
          cartItems.push({ id: product.variants[0].id, quantity: item.quantity || 1 });
        }
      }

      if (cartItems.length > 0) {
        try {
          await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cartItems })
          });
          this.showToast(`${cartItems.length} articles ajoutés !`);
          document.querySelector('cart-drawer')?.open();
        } catch (e) {
          console.error(e);
        }
      }
    }

    resizeImage(url, size) {
      if (!url) return '';
      return url.replace(/\.(jpg|png|gif|jpeg|webp)/i, `_${size}.$1`);
    }

    formatMoney(cents) {
      if (typeof cents === 'string') cents = parseInt(cents);
      const value = (cents / 100).toFixed(2);
      return this.moneyFormat
        .replace(/\{\{\s*amount\s*\}\}/g, value)
        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, value.replace('.', ','));
    }

    showToast(message) {
      const messageEl = this.toast.querySelector('span');
      if (messageEl) messageEl.textContent = message;
      this.toast.classList.add('show');
      setTimeout(() => this.toast.classList.remove('show'), 3000);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new WishlistPremium());
  } else {
    new WishlistPremium();
  }
})();
</script>

{% schema %}
{
  "name": "Wishlist Premium Grid",
  "settings": [
    {
      "type": "header",
      "content": "Contenu"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Ma Liste d'Envies"
    }
  ],
  "presets": [
    {
      "name": "Wishlist Premium Grid"
    }
  ]
}
{% endschema %}

{% comment %}
  Wishlist Nike Style - Design fidèle Nike.com
  Avec sélecteurs de variantes dynamiques
  Compatible: 100% avec système existant (wishlist-sig-items)
{% endcomment %}

<section class="wishlist-nike" data-section-id="{{ section.id }}">
  <div class="page-width">

    {%- comment -%} Header Nike style {%- endcomment -%}
    <header class="wl-nike-header">
      <h1 class="wl-nike-title">{{ section.settings.title }}</h1>
      <div class="wl-nike-meta">
        <span class="wl-nike-count" data-count-display>0 Articles</span>
        <button class="wl-nike-clear" data-clear-all style="display:none;">Tout supprimer</button>
      </div>
    </header>

    {%- comment -%} Grid cartes produits {%- endcomment -%}
    <div class="wl-nike-grid" data-wishlist-container></div>

    {%- comment -%} Empty state {%- endcomment -%}
    <div class="wl-nike-empty hidden" data-empty-state>
      <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
      </svg>
      <h2>Votre liste est vide</h2>
      <a href="{{ routes.all_products_collection_url }}" class="wl-nike-btn">Continuer mes achats</a>
    </div>

  </div>
</section>

{% style %}
  /* ========== DESIGN SYSTEM NIKE ========== */
  .wishlist-nike {
    padding: 2rem 0 4rem;
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }

  .wishlist-nike .page-width {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 1.5rem;
  }

  /* ========== HEADER NIKE ========== */
  .wl-nike-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 2rem;
    margin-bottom: 2rem;
    border-bottom: 1px solid #e5e5e5;
  }

  .wl-nike-title {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 500;
    letter-spacing: -0.02em;
  }

  .wl-nike-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .wl-nike-count {
    font-size: 0.875rem;
    color: #757575;
  }

  .wl-nike-clear {
    background: none;
    border: none;
    text-decoration: underline;
    cursor: pointer;
    font-size: 0.875rem;
    color: #111;
    padding: 0;
  }

  .wl-nike-clear:hover {
    color: #757575;
  }

  /* ========== GRID NIKE (Espacement généreux) ========== */
  .wl-nike-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  /* ========== CARD NIKE MINIMALISTE ========== */
  .wl-nike-card {
    display: flex;
    gap: 1.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid #e5e5e5;
  }

  .wl-nike-card__media {
    flex-shrink: 0;
    width: 150px;
    height: 150px;
    position: relative;
    overflow: hidden;
    background: #f5f5f5;
  }

  .wl-nike-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .wl-nike-card__checkbox {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #111;
  }

  .wl-nike-card__content {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .wl-nike-card__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .wl-nike-card__info {
    flex: 1;
    min-width: 0;
  }

  .wl-nike-card__title {
    font-size: 1rem;
    font-weight: 500;
    margin: 0 0 0.25rem;
    line-height: 1.4;
  }

  .wl-nike-card__title a {
    color: #111;
    text-decoration: none;
  }

  .wl-nike-card__title a:hover {
    color: #757575;
  }

  .wl-nike-card__subtitle {
    font-size: 0.875rem;
    color: #757575;
    margin: 0;
    line-height: 1.5;
  }

  .wl-nike-card__price {
    font-size: 0.875rem;
    font-weight: 500;
    color: #111;
    margin-left: 1rem;
    white-space: nowrap;
  }

  /* ========== VARIANT SELECTORS ========== */
  .wl-nike-card__variants {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.75rem;
  }

  .wl-nike-variant {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    min-width: 120px;
  }

  .wl-nike-variant__label {
    font-size: 0.75rem;
    color: #757575;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .wl-nike-variant__select {
    padding: 0.5rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    background: #fff;
    font-size: 0.875rem;
    color: #111;
    font-family: inherit;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .wl-nike-variant__select:hover {
    border-color: #111;
  }

  .wl-nike-variant__select:focus {
    outline: none;
    border-color: #111;
  }

  .wl-nike-card__meta {
    display: flex;
    gap: 1.5rem;
    margin-top: 0.75rem;
    font-size: 0.875rem;
    color: #757575;
  }

  .wl-nike-card__stock {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .wl-nike-card__stock--in {
    color: #107c10;
  }

  .wl-nike-card__stock--out {
    color: #d32f2f;
  }

  .wl-nike-card__actions {
    display: flex;
    gap: 1rem;
    margin-top: auto;
    padding-top: 1rem;
  }

  .wl-nike-card__qty {
    display: inline-flex;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 30px;
    height: 36px;
    padding: 0 0.5rem;
  }

  .wl-nike-card__qty-btn {
    background: none;
    border: none;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #111;
    border-radius: 50%;
    transition: background 0.2s;
  }

  .wl-nike-card__qty-btn:hover {
    background: #f5f5f5;
  }

  .wl-nike-card__qty-value {
    min-width: 32px;
    text-align: center;
    font-size: 0.875rem;
  }

  .wl-nike-card__remove {
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    color: #757575;
  }

  .wl-nike-card__remove:hover {
    color: #111;
  }

  .wl-nike-card__remove svg {
    width: 20px;
    height: 20px;
  }

  .wl-nike-note {
    font-size: 0.75rem;
    color: #757575;
    font-style: italic;
    margin-top: 0.5rem;
  }

  /* ========== BOUTON NIKE ========== */
  .wl-nike-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1.5rem;
    background: #111;
    color: #fff;
    border: none;
    border-radius: 30px;
    font-size: 0.9375rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    transition: background 0.2s;
    height: 48px;
  }

  .wl-nike-btn:hover {
    background: #757575;
  }

  .wl-nike-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
  }

  /* ========== EMPTY STATE ========== */
  .wl-nike-empty {
    text-align: center;
    padding: 4rem 1rem;
  }

  .wl-nike-empty svg {
    color: #ccc;
    margin-bottom: 1.5rem;
  }

  .wl-nike-empty h2 {
    font-size: 1.5rem;
    font-weight: 500;
    margin: 0 0 1.5rem;
  }

  .hidden {
    display: none !important;
  }

  /* ========== SKELETON ========== */
  .wl-nike-skeleton {
    animation: pulse 1.5s ease-in-out infinite;
  }

  .wl-nike-skeleton__media {
    width: 150px;
    height: 150px;
    background: #f0f0f0;
    flex-shrink: 0;
  }

  .wl-nike-skeleton__content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .wl-nike-skeleton__line {
    height: 12px;
    background: #f0f0f0;
    border-radius: 4px;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* ========== TOAST ========== */
  .wl-nike-toast {
    position: fixed;
    top: 5rem;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    background: #111;
    color: #fff;
    padding: 1rem 1.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
    opacity: 0;
    transition: all 0.3s;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }

  .wl-nike-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  /* ========== RESPONSIVE TABLET ========== */
  @media (min-width: 768px) {
    .wishlist-nike .page-width {
      padding: 0 2.5rem;
    }

    .wl-nike-header {
      padding-bottom: 2.5rem;
      margin-bottom: 2.5rem;
    }

    .wl-nike-title {
      font-size: 2rem;
    }

    .wl-nike-card__media {
      width: 180px;
      height: 180px;
    }

    .wl-nike-skeleton__media {
      width: 180px;
      height: 180px;
    }

    .wl-nike-variant {
      min-width: 140px;
    }
  }

  /* ========== RESPONSIVE DESKTOP ========== */
  @media (min-width: 1024px) {
    .wl-nike-title {
      font-size: 2.25rem;
    }

    .wl-nike-card {
      gap: 2rem;
    }

    .wl-nike-card__media {
      width: 200px;
      height: 200px;
    }

    .wl-nike-skeleton__media {
      width: 200px;
      height: 200px;
    }
  }

  /* ========== MOBILE ========== */
  @media (max-width: 767px) {
    .wl-nike-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }

    .wl-nike-meta {
      width: 100%;
      justify-content: space-between;
    }

    .wl-nike-card {
      flex-direction: column;
      gap: 1rem;
    }

    .wl-nike-card__media {
      width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
    }

    .wl-nike-card__header {
      flex-direction: column;
      gap: 0.5rem;
    }

    .wl-nike-card__price {
      margin-left: 0;
    }

    .wl-nike-skeleton__media {
      width: 100%;
      height: auto;
      aspect-ratio: 1 / 1;
    }

    .wl-nike-variant {
      min-width: calc(50% - 0.375rem);
    }
  }
{% endstyle %}

<div class="wl-nike-toast" data-toast></div>

<script>
(function() {
  'use strict';

  class WishlistNike {
    constructor() {
      this.NAMESPACE = 'wishlist-sig-';
      this.STORAGE_KEY = this.NAMESPACE + 'items';
      this.container = document.querySelector('[data-wishlist-container]');
      this.emptyState = document.querySelector('[data-empty-state]');
      this.countDisplay = document.querySelector('[data-count-display]');
      this.clearBtn = document.querySelector('[data-clear-all]');
      this.toast = document.querySelector('[data-toast]');
      
      this.productsCache = {};
      this.moneyFormat = {{ shop.money_format | json }};
      
      if (!this.container) return;
      this.init();
    }

    init() {
      this.render();
      this.attachEvents();
      window.addEventListener(this.NAMESPACE + 'updated', () => this.render());
    }

    getWishlist() {
      try {
        const items = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || '[]');
        return Array.isArray(items) ? items : [];
      } catch {
        return [];
      }
    }

    setWishlist(items) {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(items));
      window.dispatchEvent(new CustomEvent(this.NAMESPACE + 'updated'));
    }

    async render() {
      const items = this.getWishlist();
      
      this.countDisplay.textContent = `${items.length} Article${items.length !== 1 ? 's' : ''}`;
      
      if (items.length === 0) {
        this.container.innerHTML = '';
        this.container.classList.add('hidden');
        this.emptyState.classList.remove('hidden');
        this.clearBtn.style.display = 'none';
        return;
      }

      this.container.classList.remove('hidden');
      this.emptyState.classList.add('hidden');
      this.clearBtn.style.display = 'block';

      this.renderSkeletons(items.length);

      const products = await Promise.all(
        items.map(item => this.fetchProduct(item.handle))
      );

      this.container.innerHTML = products
        .filter(p => p)
        .map((product, idx) => this.buildCard(product, items[idx]))
        .join('');
    }

    async fetchProduct(handle) {
      if (this.productsCache[handle]) return this.productsCache[handle];

      try {
        const res = await fetch(`/products/${handle}.js`);
        if (!res.ok) throw new Error('Not found');
        const product = await res.json();
        this.productsCache[handle] = product;
        return product;
      } catch {
        return null;
      }
    }

    buildCard(product, itemData) {
      const variant = product.variants[0];
      const price = this.formatMoney(variant.price);
      const inStock = variant.available;
      const qty = itemData.quantity || 1;
      const note = itemData.note || '';
      const imageUrl = this.resizeImage(variant.featured_image?.src || product.featured_image, '400x');

      // Construction des sélecteurs de variantes
      let variantsHTML = '';
      if (product.options && product.options.length > 0 && product.options[0].name !== 'Title') {
        variantsHTML = '<div class="wl-nike-card__variants">';
        
        product.options.forEach((option, optionIndex) => {
          variantsHTML += `
            <div class="wl-nike-variant">
              <label class="wl-nike-variant__label">${option.name}</label>
              <select class="wl-nike-variant__select" data-option-index="${optionIndex}" data-product-handle="${product.handle}">
                ${option.values.map(value => `
                  <option value="${value}" ${variant.options[optionIndex] === value ? 'selected' : ''}>
                    ${value}
                  </option>
                `).join('')}
              </select>
            </div>
          `;
        });
        
        variantsHTML += '</div>';
      }

      return `
        <div class="wl-nike-card" data-handle="${product.handle}" data-product-id="${product.id}">
          <div class="wl-nike-card__media">
            <input type="checkbox" class="wl-nike-card__checkbox" data-select="${product.handle}">
            <a href="${product.url}">
              <img class="wl-nike-card__image" src="${imageUrl}" alt="${product.title}" loading="lazy" data-card-image>
            </a>
          </div>

          <div class="wl-nike-card__content">
            <div class="wl-nike-card__header">
              <div class="wl-nike-card__info">
                <h3 class="wl-nike-card__title"><a href="${product.url}">${product.title}</a></h3>
                <p class="wl-nike-card__subtitle">${product.product_type || 'Produit'}</p>
              </div>
              <div class="wl-nike-card__price" data-card-price>${price}</div>
            </div>

            ${variantsHTML}

            <div class="wl-nike-card__meta">
              <div class="wl-nike-card__qty-label">Quantité</div>
              <div class="wl-nike-card__stock wl-nike-card__stock--${inStock ? 'in' : 'out'}" data-card-stock>
                ${inStock ? '✓ En stock' : '✕ Épuisé'}
              </div>
            </div>

            ${note ? `<div class="wl-nike-note">${note}</div>` : ''}

            <div class="wl-nike-card__actions">
              <div class="wl-nike-card__qty">
                <button class="wl-nike-card__qty-btn" data-action="qty-dec" data-handle="${product.handle}">−</button>
                <span class="wl-nike-card__qty-value">${qty}</span>
                <button class="wl-nike-card__qty-btn" data-action="qty-inc" data-handle="${product.handle}">+</button>
              </div>

              <button class="wl-nike-btn" data-action="add-cart" data-handle="${product.handle}" data-variant-id="${variant.id}" ${!inStock ? 'disabled' : ''}>
                ${inStock ? 'Ajouter au panier' : 'Épuisé'}
              </button>

              <button class="wl-nike-card__remove" data-action="remove" data-handle="${product.handle}" title="Supprimer">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                  <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    renderSkeletons(count) {
      const skeleton = `
        <div class="wl-nike-card wl-nike-skeleton">
          <div class="wl-nike-skeleton__media"></div>
          <div class="wl-nike-skeleton__content">
            <div class="wl-nike-skeleton__line" style="width:70%"></div>
            <div class="wl-nike-skeleton__line" style="width:40%"></div>
            <div class="wl-nike-skeleton__line" style="width:60%"></div>
          </div>
        </div>
      `;
      this.container.innerHTML = skeleton.repeat(Math.min(count, 6));
    }

    attachEvents() {
      this.container.addEventListener('click', (e) => {
        const action = e.target.closest('[data-action]');
        if (!action) return;

        const handle = action.dataset.handle;

        switch(action.dataset.action) {
          case 'remove': this.removeItem(handle); break;
          case 'add-cart': this.addToCart(handle, action); break;
          case 'qty-inc': this.updateQty(handle, 1); break;
          case 'qty-dec': this.updateQty(handle, -1); break;
        }
      });

      // Event pour changement de variante
      this.container.addEventListener('change', (e) => {
        if (e.target.matches('.wl-nike-variant__select')) {
          const select = e.target;
          const handle = select.dataset.productHandle;
          this.handleVariantChange(handle);
        }
      });

      this.clearBtn?.addEventListener('click', () => {
        if (confirm('Vider votre liste ?')) {
          this.setWishlist([]);
          this.showToast('Liste vidée');
        }
      });
    }

    handleVariantChange(handle) {
      const card = this.container.querySelector(`[data-handle="${handle}"]`);
      if (!card) return;

      const product = this.productsCache[handle];
      if (!product) return;

      // Récupérer toutes les options sélectionnées
      const selects = card.querySelectorAll('.wl-nike-variant__select');
      const selectedOptions = Array.from(selects).map(s => s.value);

      // Trouver la variante correspondante
      const matchingVariant = product.variants.find(v => 
        v.options.every((opt, idx) => opt === selectedOptions[idx])
      );

      if (!matchingVariant) return;

      // Mettre à jour le prix
      const priceEl = card.querySelector('[data-card-price]');
      if (priceEl) {
        priceEl.textContent = this.formatMoney(matchingVariant.price);
      }

      // Mettre à jour l'image
      const imageEl = card.querySelector('[data-card-image]');
      if (imageEl && matchingVariant.featured_image) {
        imageEl.src = this.resizeImage(matchingVariant.featured_image.src, '400x');
      }

      // Mettre à jour le stock
      const stockEl = card.querySelector('[data-card-stock]');
      if (stockEl) {
        const inStock = matchingVariant.available;
        stockEl.className = `wl-nike-card__stock wl-nike-card__stock--${inStock ? 'in' : 'out'}`;
        stockEl.textContent = inStock ? '✓ En stock' : '✕ Épuisé';
      }

      // Mettre à jour le bouton ATC
      const btn = card.querySelector('[data-action="add-cart"]');
      if (btn) {
        btn.dataset.variantId = matchingVariant.id;
        btn.disabled = !matchingVariant.available;
        btn.textContent = matchingVariant.available ? 'Ajouter au panier' : 'Épuisé';
      }
    }

    removeItem(handle) {
      const items = this.getWishlist().filter(i => i.handle !== handle);
      this.setWishlist(items);
      this.showToast('Produit retiré');
    }

    updateQty(handle, delta) {
      const items = this.getWishlist();
      const item = items.find(i => i.handle === handle);
      if (item) {
        item.quantity = Math.max(1, (item.quantity || 1) + delta);
        this.setWishlist(items);
      }
    }

    async addToCart(handle, btn) {
      const item = this.getWishlist().find(i => i.handle === handle);
      const variantId = btn.dataset.variantId;
      
      if (!item || !variantId) return;

      const originalText = btn.textContent;
      btn.textContent = '...';
      btn.disabled = true;

      try {
        const formData = {
          items: [{
            id: variantId,
            quantity: item.quantity || 1
          }]
        };

        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (!response.ok) throw new Error('Erreur ajout panier');

        // Ouvrir le cart drawer (méthode exacte de votre thème)
        if (window.cartDrawerInstance) {
          await window.cartDrawerInstance.refreshDrawer();
          window.cartDrawerInstance.open();
          
          const cartResponse = await fetch('/cart.js');
          const cart = await cartResponse.json();
          window.cartDrawerInstance.updateCartCount(cart.item_count);
        }

        this.showToast('Ajouté au panier !');
      } catch (e) {
        console.error(e);
        this.showToast('Erreur, réessayez');
      } finally {
        btn.textContent = originalText;
      }
    }

    resizeImage(url, size) {
      if (!url) return '';
      return url.replace(/\.(jpg|png|gif|jpeg|webp)/i, `_${size}.$1`);
    }

    formatMoney(cents) {
      if (typeof cents === 'string') cents = parseInt(cents);
      const value = (cents / 100).toFixed(2);
      return this.moneyFormat
        .replace(/\{\{\s*amount\s*\}\}/g, value)
        .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, value.replace('.', ','));
    }

    showToast(message) {
      this.toast.textContent = message;
      this.toast.classList.add('show');
      setTimeout(() => this.toast.classList.remove('show'), 3000);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new WishlistNike());
  } else {
    new WishlistNike();
  }
})();
</script>

{% schema %}
{
  "name": "Wishlist Nike Style",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Titre",
      "default": "Favoris"
    }
  ],
  "presets": [
    {
      "name": "Wishlist Nike Style"
    }
  ]
}
{% endschema %}

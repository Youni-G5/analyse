{% comment %}
  Snippet: mobile-optimizations.liquid
  Description: Optimisations spécifiques mobile pour améliorer PageSpeed Mobile
  Objectif: Passer de 65/100 à 90+/100
{% endcomment %}

{% comment %} 1. FONT DISPLAY SWAP - Évite le blocage du texte {% endcomment %}
<style>
  @font-face {
    font-family: 'Inter';
    font-display: swap;
    src: url('https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfAZ9hiA.woff2') format('woff2');
  }
</style>

{% comment %} 2. CRITICAL CSS INLINE - Premier rendu immédiat {% endcomment %}
<style>
  body{margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;-webkit-font-smoothing:antialiased}
  .container{max-width:1200px;margin:0 auto;padding:0 24px}
  .mobile-only{display:block!important}
  .desktop-only{display:none!important}
  @media(min-width:990px){.mobile-only{display:none!important}.desktop-only{display:block!important}}
  .site-header{background:#fff;border-bottom:1px solid #e5e5e5;position:sticky;top:0;z-index:20}
  .header-content{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;height:60px;padding:0 15px}
  .skeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:loading 1.5s infinite}
  @keyframes loading{0%{background-position:200% 0}100%{background-position:-200% 0}}
</style>

{% comment %} 3. PRECONNECT DNS MOBILE - Connexions précoces {% endcomment %}
<link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

{% comment %} DNS Prefetch pour scripts tiers (mobile) {% endcomment %}
<link rel="dns-prefetch" href="https://www.googletagmanager.com">
<link rel="dns-prefetch" href="https://connect.facebook.net">
<link rel="dns-prefetch" href="https://analytics.tiktok.com">
<link rel="dns-prefetch" href="https://sc-static.net">

{% comment %} 4. DEFER ANALYTICS - Charge après interaction utilisateur {% endcomment %}
{% comment %} NOTE: Analytics sera chargé via le snippet analytics.liquid standard {% endcomment %}
{% comment %} Cette section est désactivée pour éviter les problèmes d'affichage {% endcomment %}

{% comment %} 5. RESPONSIVE IMAGES - Tailles adaptées mobile {% endcomment %}
{% if type == 'responsive-image' and image %}
  <img 
    src="{{ image | image_url: width: 50 }}" 
    srcset="
      {{ image | image_url: width: 400 }} 400w,
      {{ image | image_url: width: 800 }} 800w,
      {{ image | image_url: width: 1200 }} 1200w
    "
    sizes="
      (max-width: 640px) 100vw,
      (max-width: 1024px) 50vw,
      33vw
    "
    width="{{ image.width }}"
    height="{{ image.height }}"
    loading="lazy"
    decoding="async"
    alt="{{ image.alt | escape }}"
    class="skeleton"
  >
{% endif %}

{% comment %} 6. INTERSECTION OBSERVER - Lazy load intelligent {% endcomment %}
<script>
(function() {
  if (!('IntersectionObserver' in window)) return;
  
  var imageObserver = new IntersectionObserver(function(entries, observer) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        var img = entry.target;
        
        if (img.dataset.src) {
          img.src = img.dataset.src;
          img.removeAttribute('data-src');
        }
        
        if (img.dataset.srcset) {
          img.srcset = img.dataset.srcset;
          img.removeAttribute('data-srcset');
        }
        
        img.classList.remove('skeleton');
        observer.unobserve(img);
      }
    });
  }, {
    rootMargin: '50px 0px',
    threshold: 0.01
  });
  
  document.querySelectorAll('img[loading="lazy"]').forEach(function(img) {
    imageObserver.observe(img);
  });
})();
</script>

{% comment %} 7. REDUCE LAYOUT SHIFT - Réserve espace images {% endcomment %}
<style>
  .aspect-ratio-box {
    position: relative;
    width: 100%;
    height: 0;
  }
  
  .aspect-ratio-box--1-1 { padding-bottom: 100%; }
  .aspect-ratio-box--4-3 { padding-bottom: 75%; }
  .aspect-ratio-box--16-9 { padding-bottom: 56.25%; }
  
  .aspect-ratio-box__content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
</style>

{% comment %} 8. MOBILE MENU OPTIMIZATION - Defer rendering {% endcomment %}
<script>
(function() {
  if (window.innerWidth >= 990) return;
  
  if ('requestIdleCallback' in window) {
    requestIdleCallback(function() {
      if (typeof initHeaderMenu === 'function') {
        initHeaderMenu();
      }
    });
  } else {
    setTimeout(function() {
      if (typeof initHeaderMenu === 'function') {
        initHeaderMenu();
      }
    }, 100);
  }
})();
</script>

{% comment %} 9. WEB VITALS MONITORING - Mesure performance réelle {% endcomment %}
<script>
(function() {
  if (!('PerformanceObserver' in window)) return;
  
  try {
    var lcpObserver = new PerformanceObserver(function(list) {
      var entries = list.getEntries();
      var lastEntry = entries[entries.length - 1];
      console.log('LCP:', lastEntry.renderTime || lastEntry.loadTime);
    });
    lcpObserver.observe({ entryTypes: ['largest-contentful-paint'] });
    
    var clsScore = 0;
    var clsObserver = new PerformanceObserver(function(list) {
      var entries = list.getEntries();
      for (var i = 0; i < entries.length; i++) {
        var entry = entries[i];
        if (!entry.hadRecentInput) {
          clsScore += entry.value;
        }
      }
      console.log('CLS:', clsScore);
    });
    clsObserver.observe({ entryTypes: ['layout-shift'] });
    
    var fidObserver = new PerformanceObserver(function(list) {
      var entries = list.getEntries();
      for (var i = 0; i < entries.length; i++) {
        var entry = entries[i];
        console.log('FID:', entry.processingStart - entry.startTime);
      }
    });
    fidObserver.observe({ entryTypes: ['first-input'] });
  } catch(e) {
    console.log('Web Vitals monitoring not supported');
  }
})();
</script>
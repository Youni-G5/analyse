{%- assign style = button_style | default: 'footer' -%}

{%- comment -%}
  LOGIQUE DE TRADUCTION
{%- endcomment -%}
{%- assign current_lang = localization.language.iso_code -%}

{%- case current_lang -%}
  {%- when 'en' -%}
    {%- assign t_country_label = "Country / Region" -%}
    {%- assign t_language_label = "Language" -%}
    {%- assign t_update_btn = "Save" -%}
    {%- assign t_cancel_btn = "Cancel" -%}
    {%- assign t_modal_title = "Region and language settings" -%}
    {%- assign t_close_modal = "Close" -%}
  {%- when 'de' -%}
    {%- assign t_country_label = "Land / Region" -%}
    {%- assign t_language_label = "Sprache" -%}
    {%- assign t_update_btn = "Speichern" -%}
    {%- assign t_cancel_btn = "Abbrechen" -%}
    {%- assign t_modal_title = "Regions- und Spracheinstellungen" -%}
    {%- assign t_close_modal = "Schließen" -%}
  {%- else -%}
    {%- assign t_country_label = "Pays / Région" -%}
    {%- assign t_language_label = "Langue" -%}
    {%- assign t_update_btn = "Sauvegarder" -%}
    {%- assign t_cancel_btn = "Annuler" -%}
    {%- assign t_modal_title = "Paramètres de région et langue" -%}
    {%- assign t_close_modal = "Fermer" -%}
{%- endcase -%}

{%- if localization.available_countries.size > 1 or localization.available_languages.size > 1 -%}
  <div class="localization-wrapper">
    
    <!-- TRIGGER BUTTON -->
    <button
      type="button"
      class="locale-toggle locale-toggle--{{ style }}"
      aria-expanded="false"
      aria-controls="locale-modal-{{ style }}"
    >
      {%- if style == 'header' -%}
        <span class="locale-text-header">
          {{ t_country_label }} : <span class="locale-country-underlined">{{ localization.country.name }}</span>
        </span>
      {%- else -%}
        <span class="locale-text-footer">
          {{ localization.country.name }}
        </span>
        <span class="locale-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="2" y1="12" x2="22" y2="12"></line>
            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
          </svg>
        </span>
      {%- endif -%}
    </button>
  </div>

  <!-- MODAL STRUCTURE -->
  <div class="locale-backdrop js-locale-backdrop" hidden></div>

  <!-- Ajout de la classe dynamique locale-modal--header ou locale-modal--footer -->
  <div class="locale-modal locale-modal--{{ style }} js-locale-modal" hidden role="dialog" aria-modal="true" aria-label="{{ t_close_modal }}">
    
    <!-- HEADER COMPACT -->
    <div class="modal-header-bar">
      <button type="button" class="modal-close-btn js-modal-close" aria-label="{{ t_close_modal }}">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
    
    {% form 'localization', class: 'modal-form' %}
      
      <div class="modal-body">
        <h2 class="modal-body-title">{{ t_modal_title }}</h2>

        <div class="modal-selectors">
          {% if localization.available_languages.size > 1 %}
            <div class="modal-group">
              <label class="input-label">{{ t_language_label }}</label>
              <div class="select-wrapper">
                <select name="language_code" class="modal-select">
                  {% for language in localization.available_languages %}
                    <option value="{{ language.iso_code }}" {% if language.iso_code == localization.language.iso_code %}selected{% endif %}>
                      {{ language.endonym_name | capitalize }}
                    </option>
                  {% endfor %}
                </select>
                <svg class="select-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
            </div>
          {% endif %}

          {% if localization.available_countries.size > 1 %}
            <div class="modal-group">
              <label class="input-label">{{ t_country_label }}</label>
              <div class="select-wrapper">
                <select name="country_code" class="modal-select">
                  {% for country in localization.available_countries %}
                    <option value="{{ country.iso_code }}" {% if country.iso_code == localization.country.iso_code %}selected{% endif %}>
                      {{ country.name }} ({{ country.currency.iso_code }})
                    </option>
                  {% endfor %}
                </select>
                <svg class="select-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-zalando btn-secondary js-modal-close">
          {{ t_cancel_btn }}
        </button>
        <button type="submit" class="btn-zalando btn-primary">
          {{ t_update_btn }}
        </button>
      </div>

    {% endform %}
  </div>

  <style>
    /* --- THÈMES DE COULEURS (CSS VARIABLES) --- */
    
    /* Par défaut (Light Mode - Style Footer) */
    .locale-modal {
      --z-bg: #ffffff;
      --z-text: #1a1a1a;
      --z-border: #d0d1d3;
      --z-hover-bg: #f5f5f5;
      --z-input-bg: #ffffff;
      --z-input-border: #d0d1d3;
      --z-btn-primary-bg: #000000;
      --z-btn-primary-text: #ffffff;
      --z-btn-secondary-bg: #ffffff;
      --z-btn-secondary-text: #000000;
      --z-btn-secondary-border: #000000;
    }

    /* Mode Sombre (Dark Mode - Style Header) */
    .locale-modal--header {
      --z-bg: #111111;
      --z-text: #ffffff;
      --z-border: #333333;
      --z-hover-bg: #222222;
      --z-input-bg: #000000;
      --z-input-border: #444444;
      --z-btn-primary-bg: #ffffff;
      --z-btn-primary-text: #000000;
      --z-btn-secondary-bg: #111111;
      --z-btn-secondary-text: #ffffff;
      --z-btn-secondary-border: #ffffff;
    }

    /* --- Trigger --- */
    .localization-wrapper { position: relative; display: inline-block; z-index: 10; }
    .locale-toggle { display: inline-flex; align-items: center; background: transparent; border: none; cursor: pointer; padding: 0; font-family: inherit; }
    .locale-toggle--footer { gap: 6px; color: #999; font-size: 12px; font-weight: 500; padding: 8px 0; }
    .locale-toggle--header { border: 1px solid rgba(255,255,255,0.5); background: #000; color: #fff; padding: 5px 10px; font-size: 11px; line-height: 1; }
    .locale-country-underlined { text-decoration: underline; text-underline-offset: 3px; font-weight: 600; }
    [hidden] { display: none !important; }

    /* --- Backdrop --- */
    .locale-backdrop { 
      position: fixed; inset: 0; 
      background: rgba(0, 0, 0, 0.6); 
      z-index: 2147483646; 
      backdrop-filter: blur(2px);
    }

    /* --- Modal Container --- */
    .locale-modal { 
      position: fixed; top: 50%; left: 50%; 
      transform: translate(-50%, -50%); 
      width: 90%; 
      max-width: 420px; 
      background: var(--z-bg); 
      z-index: 2147483647; 
      display: flex; flex-direction: column; 
      color: var(--z-text); 
      box-shadow: 0 4px 30px rgba(0,0,0,0.25);
      border-radius: 0;
      border: 1px solid var(--z-border); 
    }

    /* --- Header --- */
    .modal-header-bar {
      display: flex;
      justify-content: flex-end;
      padding: 8px 12px; 
      border-bottom: 1px solid var(--z-border);
    }

    .modal-close-btn {
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      background: transparent;
      border: none;
      cursor: pointer;
      color: var(--z-text);
      border-radius: 50%;
      transition: background-color 0.2s;
    }
    .modal-close-btn:hover {
      background-color: var(--z-hover-bg);
    }
    .modal-close-btn svg { width: 28px; height: 28px; }

    /* --- Body --- */
    .modal-body { 
      padding: 24px 32px 20px; 
      display: flex; flex-direction: column; gap: 20px;
    }

    .modal-body-title {
      margin: 0;
      font-size: 18px; 
      font-weight: 700;
      line-height: 1.2;
      color: var(--z-text);
      text-align: left;
    }

    .modal-selectors { display: flex; flex-direction: column; gap: 14px; }
    .modal-group { display: flex; flex-direction: column; gap: 6px; }
    .input-label { font-size: 13px; font-weight: 600; color: var(--z-text); margin-bottom: 2px; opacity: 0.9; }

    .select-wrapper { position: relative; }
    .modal-select { 
      width: 100%; 
      padding: 12px 36px 12px 12px; 
      background: var(--z-input-bg); 
      color: var(--z-text); 
      border: 1px solid var(--z-input-border); 
      font-size: 15px; 
      font-weight: 400;
      appearance: none; 
      outline: none; 
      cursor: pointer;
      border-radius: 0;
      transition: border-color 0.2s;
    }
    .modal-select option { background: var(--z-bg); color: var(--z-text); }
    .modal-select:hover { border-color: var(--z-text); opacity: 0.7; }
    .modal-select:focus { border-color: var(--z-text); opacity: 1; }
    
    .select-chevron { 
      position: absolute; right: 12px; top: 50%; 
      transform: translateY(-50%); 
      pointer-events: none; color: var(--z-text); 
    }

    /* --- Footer --- */
    .modal-footer { 
      padding: 16px 32px 20px;
      border-top: 1px solid var(--z-border); 
      display: flex; 
      justify-content: flex-end; 
      gap: 12px; 
    }
    
    .btn-zalando { 
      padding: 10px 20px; 
      font-size: 13px; 
      font-weight: 700;
      cursor: pointer; 
      text-align: center;
      min-width: 100px;
      border-radius: 0;
      transition: all 0.2s ease;
      letter-spacing: 0.5px;
    }
    
    /* Bouton Secondaire (Annuler) */
    .btn-secondary { 
      background: var(--z-btn-secondary-bg); 
      color: var(--z-btn-secondary-text); 
      border: 2px solid var(--z-btn-secondary-border); 
    }
    .btn-secondary:hover { opacity: 0.7; }
    
    /* Bouton Primaire (Sauvegarder) */
    .btn-primary { 
      background: var(--z-btn-primary-bg); 
      color: var(--z-btn-primary-text); 
      border: 2px solid var(--z-btn-primary-bg);
    }
    .btn-primary:hover { opacity: 0.8; }

    /* Mobile */
    @media (max-width: 480px) {
      /* Définition de l'animation slide-up */
      @keyframes modalSlideUp {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }

      .locale-modal { 
        width: 100%; 
        max-width: 100%; 
        bottom: 0; 
        top: auto; 
        left: 0; 
        transform: none; /* Important pour éviter le conflit avec l'animation */
        border-radius: 12px 12px 0 0; /* Un petit arrondi sympa en haut pour le look 'sheet' */
        border-bottom: none;
      }
      
      /* Appliquer l'animation uniquement quand le modal est visible */
      .locale-modal:not([hidden]) {
        animation: modalSlideUp 0.35s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }

      .modal-footer { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const wrappers = document.querySelectorAll('.localization-wrapper');
      wrappers.forEach(wrapper => {
        const toggle = wrapper.querySelector('.locale-toggle');
        let nextEl = wrapper.nextElementSibling;
        while(nextEl && !nextEl.classList.contains('js-locale-backdrop')) {
           nextEl = nextEl.nextElementSibling;
        }
        const backdrop = nextEl;
        const modal = backdrop ? backdrop.nextElementSibling : null;
        
        if (!toggle || !modal || !backdrop) return;

        const closeBtns = modal.querySelectorAll('.js-modal-close');

        document.body.appendChild(backdrop);
        document.body.appendChild(modal);

        function openModal() {
          modal.hidden = false;
          backdrop.hidden = false;
          toggle.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden';
        }

        function closeModal() {
          modal.hidden = true;
          backdrop.hidden = true;
          toggle.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }

        toggle.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          openModal();
        });
        
        closeBtns.forEach(btn => btn.addEventListener('click', closeModal));
        backdrop.addEventListener('click', closeModal);
      });
    });
  </script>
{%- endif -%}
